<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Training Pipeline &#8212; Multi-model Biomedical LLM  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Inference Pipeline" href="inference_pipeline.html" />
    <link rel="prev" title="Data Preprocessing Pipeline" href="data_pipeline.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="training-pipeline">
<h1>Training Pipeline<a class="headerlink" href="#training-pipeline" title="Link to this heading">¶</a></h1>
<p>This document outlines the source code used to train the various LLMs in this project,
including classification, summarization, and intent detection models. It includes details regarding
modifications to parameters, configurations, and adapters used during training.</p>
<p>Also included are the metrics and evaluation functions used to assess model performance during training,
as well as the custom Callbacks used to improve GPU usage and log metrics.</p>
<section id="source-code">
<h2>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Module to set up training tasks for all NLP models.</span>
<span class="linenos">  3</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoConfig</span><span class="p">,</span> <span class="n">DataCollatorWithPadding</span><span class="p">,</span> <span class="n">DataCollatorForSeq2Seq</span><span class="p">,</span> <span class="n">Seq2SeqTrainer</span><span class="p">,</span> <span class="n">Seq2SeqTrainingArguments</span><span class="p">,</span> <span class="n">TrainerCallback</span>
<span class="linenos">  6</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.training_args</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainingArguments</span>
<span class="linenos">  7</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trainer</span>
<span class="linenos">  8</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.modeling_outputs</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequenceClassifierOutput</span>
<span class="linenos">  9</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.trainer_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvalPrediction</span>
<span class="linenos"> 10</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.modeling_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedModel</span>
<span class="linenos"> 11</span><span class="kn">from</span><span class="w"> </span><span class="nn">peft</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_peft_model</span><span class="p">,</span> <span class="n">LoraConfig</span><span class="p">,</span> <span class="n">TaskType</span>
<span class="linenos"> 12</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_from_disk</span>
<span class="linenos"> 13</span><span class="kn">from</span><span class="w"> </span><span class="nn">data.fetch_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_data</span>
<span class="linenos"> 14</span><span class="kn">from</span><span class="w"> </span><span class="nn">model.evaluate_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_compute_metric</span><span class="p">,</span> <span class="n">intent_compute_metrics</span><span class="p">,</span> <span class="n">rouge_metrics</span><span class="p">,</span> <span class="n">MetricsLoggerCallback</span><span class="p">,</span> <span class="n">CUDACleanupCallback</span>
<span class="linenos"> 15</span><span class="kn">from</span><span class="w"> </span><span class="nn">model.model_projection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SeqClassWProjection</span><span class="p">,</span> <span class="n">Seq2SeqWProjection</span>
<span class="linenos"> 16</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos"> 17</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 18</span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos"> 19</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 20</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos"> 21</span><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<span class="linenos"> 22</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DatasetDict</span>
<span class="linenos"> 23</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span>
<span class="linenos"> 24</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="c1">### Classification Training Pipeline ###</span>
<span class="linenos"> 30</span><span class="k">def</span><span class="w"> </span><span class="nf">classification_model_training</span><span class="p">(</span><span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_mapping_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">active_labels_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">training_checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test_data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 31</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 32</span><span class="sd">    Training method for fine-tuning a pre-trained encoder model on ICD-10 code</span>
<span class="linenos"> 33</span><span class="sd">    classification task.</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="sd">    Args:</span>
<span class="linenos"> 36</span><span class="sd">        data_dir (str): path to dataset being used for training</span>
<span class="linenos"> 37</span><span class="sd">        label_map_dir (str): path to label mapping (id2label and label2id)</span>
<span class="linenos"> 38</span><span class="sd">        active_labels_dir (str): path to dictionary of active labels</span>
<span class="linenos"> 39</span><span class="sd">        checkpoint (str): pre-trained HuggingFace model used for training</span>
<span class="linenos"> 40</span><span class="sd">        training_checkpoint_dir (str): directory to save in-training model config</span>
<span class="linenos"> 41</span><span class="sd">        save_dir (str): path to saved PEFT weights for specified task</span>
<span class="linenos"> 42</span><span class="sd">        test_data_dir (str): path to save test data to</span>
<span class="linenos"> 43</span><span class="sd">    </span>
<span class="linenos"> 44</span><span class="sd">    Returns:</span>
<span class="linenos"> 45</span><span class="sd">        None</span>
<span class="linenos"> 46</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="linenos"> 49</span>    <span class="n">train_val_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="linenos"> 50</span>    <span class="n">train_val</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
<span class="linenos"> 53</span>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="linenos"> 54</span>    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="c1"># For use when evaluating model performance after training</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span>    <span class="n">test_dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">)</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 59</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">label_mapping_dir</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos"> 60</span>            <span class="n">mappings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos"> 61</span>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<span class="linenos"> 62</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;JSON file for mapping does not exist. Must preprocess data before training.&quot;</span><span class="p">)</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span>    <span class="n">active_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">active_labels_dir</span><span class="p">)</span>
<span class="linenos"> 65</span>    <span class="n">label2id</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;label2id&quot;</span><span class="p">]</span>
<span class="linenos"> 66</span>    <span class="n">active_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">active_labels</span><span class="p">[</span><span class="s2">&quot;icd_code&quot;</span><span class="p">])</span>
<span class="linenos"> 67</span>    <span class="n">id2label</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;id2label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="linenos"> 68</span>    <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label2id</span><span class="p">)</span>
<span class="linenos"> 69</span>    <span class="n">active_label_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">label2id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">active_labels</span><span class="p">]</span>
<span class="linenos"> 70</span>    <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active_label_indices</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)]</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span>    <span class="n">metrics_logger</span> <span class="o">=</span> <span class="n">MetricsLoggerCallback</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">metric_dir</span><span class="p">)</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos"> 75</span>    <span class="n">config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="n">num_labels</span>
<span class="linenos"> 76</span>    <span class="n">config</span><span class="o">.</span><span class="n">label2id</span> <span class="o">=</span> <span class="n">label2id</span>
<span class="linenos"> 77</span>    <span class="n">config</span><span class="o">.</span><span class="n">id2label</span> <span class="o">=</span> <span class="n">id2label</span>
<span class="linenos"> 78</span>    <span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;multi_label_classification&quot;</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos"> 81</span>    <span class="n">base_model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="linenos"> 82</span>    <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DataCollatorWithPadding</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>    <span class="k">def</span><span class="w"> </span><span class="nf">collate_function</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
<span class="linenos"> 85</span>        <span class="n">batch_filtered</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<span class="linenos"> 86</span>        <span class="k">return</span> <span class="n">data_collator</span><span class="p">(</span><span class="n">batch_filtered</span><span class="p">)</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>    <span class="n">lora_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span> <span class="c1"># PERF tuning</span>
<span class="linenos"> 89</span>        <span class="n">r</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="linenos"> 90</span>        <span class="n">lora_alpha</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
<span class="linenos"> 91</span>        <span class="n">target_modules</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">],</span>
<span class="linenos"> 92</span>        <span class="n">lora_dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
<span class="linenos"> 93</span>        <span class="n">bias</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="linenos"> 94</span>        <span class="n">task_type</span><span class="o">=</span><span class="n">TaskType</span><span class="o">.</span><span class="n">SEQ_CLS</span>
<span class="linenos"> 95</span>    <span class="p">)</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>    <span class="n">peft_model</span> <span class="o">=</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">base_model</span><span class="p">,</span> <span class="n">peft_config</span><span class="o">=</span><span class="n">lora_config</span><span class="p">)</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
<span class="linenos">100</span>        <span class="n">output_dir</span><span class="o">=</span><span class="n">training_checkpoint_dir</span><span class="p">,</span>
<span class="linenos">101</span>        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="linenos">102</span>        <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># lowered batch size during eval (8 to 2)</span>
<span class="linenos">103</span>        <span class="n">eval_accumulation_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># flush intermediate evaluation results</span>
<span class="linenos">104</span>        <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="linenos">105</span>        <span class="n">eval_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">106</span>        <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">107</span>        <span class="n">logging_dir</span><span class="o">=</span><span class="s2">&quot;./logs&quot;</span><span class="p">,</span>
<span class="linenos">108</span>        <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">109</span>        <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;f1_macro&quot;</span><span class="p">,</span>
<span class="linenos">110</span>        <span class="n">greater_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">111</span>        <span class="n">remove_unused_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">112</span>        <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Uses mixed precision</span>
<span class="linenos">113</span>        <span class="n">dataloader_pin_memory</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Reduce memory overhead</span>
<span class="linenos">114</span>    <span class="p">)</span>
<span class="linenos">115</span>
<span class="linenos">116</span>    <span class="n">pos_weight</span> <span class="o">=</span> <span class="n">compute_pos_weight</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<span class="linenos">119</span>    <span class="n">base_encoder</span> <span class="o">=</span> <span class="n">peft_model</span>
<span class="linenos">120</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">SeqClassWProjection</span><span class="p">(</span>
<span class="linenos">121</span>        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> 
<span class="linenos">122</span>        <span class="n">base_encoder</span><span class="o">=</span><span class="n">base_encoder</span><span class="p">,</span>
<span class="linenos">123</span>        <span class="n">pos_weight</span><span class="o">=</span><span class="n">pos_weight</span><span class="p">,</span>
<span class="linenos">124</span>        <span class="n">active_label_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
<span class="linenos">125</span>        <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span>
<span class="linenos">126</span>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">127</span>    
<span class="linenos">128</span>    <span class="n">metrics_logger</span><span class="o">.</span><span class="n">run_counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">129</span>
<span class="linenos">130</span>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">WeightedLossTrainer</span><span class="p">(</span>
<span class="linenos">131</span>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">132</span>        <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
<span class="linenos">133</span>        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<span class="linenos">134</span>        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<span class="linenos">135</span>        <span class="n">processing_class</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos">136</span>        <span class="n">data_collator</span><span class="o">=</span><span class="n">collate_function</span><span class="p">,</span>
<span class="linenos">137</span>        <span class="n">compute_metrics</span><span class="o">=</span><span class="n">classification_compute_metric</span><span class="p">,</span>
<span class="linenos">138</span>        <span class="n">pos_weight</span><span class="o">=</span><span class="n">pos_weight</span><span class="p">,</span>
<span class="linenos">139</span>        <span class="n">active_label_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
<span class="linenos">140</span>        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">metrics_logger</span><span class="p">,</span> <span class="n">CUDACleanupCallback</span><span class="p">()]</span> <span class="c1"># callbacks for logging metrics and for clearing GPU memory for evaluation</span>
<span class="linenos">141</span>    <span class="p">)</span>
<span class="linenos">142</span>
<span class="linenos">143</span>    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos">144</span>
<span class="linenos">145</span>    <span class="n">model</span><span class="o">.</span><span class="n">save_custom</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">146</span>    <span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="k">class</span><span class="w"> </span><span class="nc">WeightedLossTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
<span class="linenos">149</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">150</span><span class="sd">    Custom Trainer subclass intended to help tackle ICD-10 class imbalance in MIMIC-IV dataset.</span>
<span class="linenos">151</span><span class="sd">    Only used with trainer for classification. </span>
<span class="linenos">152</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">153</span>
<span class="linenos">154</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
<span class="linenos">155</span>                 <span class="n">pos_weight</span><span class="p">:</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">156</span>                 <span class="n">active_label_mask</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">157</span>                 <span class="n">model</span><span class="p">:</span> <span class="n">SeqClassWProjection</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">158</span>                 <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">159</span>                 <span class="n">data_collator</span><span class="p">:</span> <span class="n">DataCollatorWithPadding</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">160</span>                 <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">161</span>                 <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">162</span>                 <span class="n">processing_class</span><span class="p">:</span> <span class="n">AutoTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">163</span>                 <span class="n">model_init</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">PreTrainedModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">164</span>                 <span class="n">compute_loss_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">165</span>                 <span class="n">compute_metrics</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">EvalPrediction</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">166</span>                 <span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TrainerCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">167</span>                 <span class="n">optimizers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> 
<span class="linenos">168</span>                 <span class="n">optimizer_cls_and_kwargs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
<span class="linenos">169</span>                 <span class="n">preprocess_logits_for_metrics</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">170</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data_collator</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="n">processing_class</span><span class="p">,</span> <span class="n">model_init</span><span class="p">,</span> <span class="n">compute_loss_func</span><span class="p">,</span> <span class="n">compute_metrics</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">optimizers</span><span class="p">,</span> <span class="n">optimizer_cls_and_kwargs</span><span class="p">,</span> <span class="n">preprocess_logits_for_metrics</span><span class="p">)</span>
<span class="linenos">171</span>                
<span class="linenos">172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">173</span>            <span class="n">pos_weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="k">if</span> <span class="n">pos_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">174</span>        <span class="p">)</span>
<span class="linenos">175</span>
<span class="linenos">176</span>        <span class="bp">self</span><span class="o">.</span><span class="n">active_label_mask</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">177</span>            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">active_label_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="k">if</span> <span class="n">active_label_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">178</span>        <span class="p">)</span>
<span class="linenos">179</span>
<span class="linenos">180</span>        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">(</span>
<span class="linenos">181</span>            <span class="n">pos_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span><span class="p">,</span>
<span class="linenos">182</span>            <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
<span class="linenos">183</span>        <span class="p">)</span>  
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">return_outputs</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">SequenceClassifierOutput</span><span class="p">]:</span>
<span class="linenos">186</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">187</span><span class="sd">        Compute loss function that provides new loss function based on positive class weights.</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="sd">        Args:</span>
<span class="linenos">190</span><span class="sd">            model (AutoModel): classification training model</span>
<span class="linenos">191</span><span class="sd">            inputs (dict[str:Tensor]): dictionary of the training inputs</span>
<span class="linenos">192</span><span class="sd">            return_outputs (bool): controlled by HuggingFace Trainer class. False during training (only loss needed). True for evaluation/prediction.</span>
<span class="linenos">193</span>
<span class="linenos">194</span><span class="sd">        Returns: </span>
<span class="linenos">195</span><span class="sd">            Tensor | (Tensor, SequenceClassifierOutput): tuple with the loss and model outputs or just the loss, depending on stage.</span>
<span class="linenos">196</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">197</span>        <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">)</span>
<span class="linenos">198</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;logits&quot;</span><span class="p">)</span>
<span class="linenos">200</span>
<span class="linenos">201</span>        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="linenos">202</span>
<span class="linenos">203</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">204</span>            <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="o">.</span><span class="n">pos_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_weight</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">205</span>
<span class="linenos">206</span>        <span class="n">loss_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="linenos">207</span>
<span class="linenos">208</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_label_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">209</span>            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_label_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">210</span>            <span class="n">loss_matrix</span> <span class="o">=</span> <span class="n">loss_matrix</span> <span class="o">*</span> <span class="n">mask</span>
<span class="linenos">211</span>
<span class="linenos">212</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="linenos">213</span>
<span class="linenos">214</span>        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_outputs</span> <span class="k">else</span> <span class="n">loss</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="k">def</span><span class="w"> </span><span class="nf">compute_pos_weight</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="linenos">217</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">218</span><span class="sd">    Function to calculate positive class weight for classification pipeline. Intended to help with class imbalance</span>
<span class="linenos">219</span><span class="sd">    by increasing the penalty of positive labels.</span>
<span class="linenos">220</span>
<span class="linenos">221</span><span class="sd">    Args:</span>
<span class="linenos">222</span><span class="sd">        dataset (Dataset): HuggingFace dataset with a &quot;labels&quot; columm. Labels are expected to contain multi-hot vectors</span>
<span class="linenos">223</span>
<span class="linenos">224</span><span class="sd">    Returns:</span>
<span class="linenos">225</span><span class="sd">        Tensor: tensor of positive class weight for each class</span>
<span class="linenos">226</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">227</span>    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
<span class="linenos">228</span>
<span class="linenos">229</span>    <span class="n">positive_counts</span> <span class="o">=</span> <span class="n">all_labels</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">230</span>    <span class="n">total_samples</span> <span class="o">=</span> <span class="n">all_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">231</span>    <span class="n">negative_counts</span> <span class="o">=</span> <span class="n">total_samples</span> <span class="o">-</span> <span class="n">positive_counts</span>
<span class="linenos">232</span>
<span class="linenos">233</span>    <span class="n">pos_weight</span> <span class="o">=</span> <span class="n">negative_counts</span> <span class="o">/</span> <span class="p">(</span><span class="n">positive_counts</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
<span class="linenos">234</span>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_weight</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="linenos">235</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="c1">### Summarization Training Pipeline ###</span>
<span class="linenos">238</span><span class="k">def</span><span class="w"> </span><span class="nf">summarization_model_training</span><span class="p">(</span><span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">training_checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test_data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">239</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">240</span><span class="sd">    Training method for fine-tuning a pre-trained encoder-decoder model on clinical note summarization task.</span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="sd">    Args:</span>
<span class="linenos">243</span><span class="sd">        data_dir (str): path to dataset being used for training</span>
<span class="linenos">244</span><span class="sd">        checkpoint (str): pre-trained HuggingFace model used for training</span>
<span class="linenos">245</span><span class="sd">        training_checkpoint_dir (str): directory to save in-training model config</span>
<span class="linenos">246</span><span class="sd">        save_dir (str): path to saved PEFT weights for specified task</span>
<span class="linenos">247</span><span class="sd">        test_data_dir (str): path to save test data to</span>
<span class="linenos">248</span><span class="sd">        metric_dir (str): path to save metrics from evaluation to</span>
<span class="linenos">249</span>
<span class="linenos">250</span><span class="sd">    Returns:</span>
<span class="linenos">251</span><span class="sd">        None</span>
<span class="linenos">252</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_from_disk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="linenos">255</span>    <span class="n">train_val_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="linenos">256</span>    <span class="n">train_val</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="linenos">257</span>
<span class="linenos">258</span>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
<span class="linenos">259</span>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">train_val</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="linenos">260</span>    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="c1"># For use when evaluating model performance after training</span>
<span class="linenos">261</span>
<span class="linenos">262</span>    <span class="n">test_dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="n">test_data_dir</span><span class="p">)</span>
<span class="linenos">263</span>
<span class="linenos">264</span>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">model_max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<span class="linenos">265</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos">266</span>    <span class="n">base_model</span> <span class="o">=</span> <span class="n">Seq2SeqWProjection</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span> <span class="c1"># modified to use projection head</span>
<span class="linenos">267</span>
<span class="linenos">268</span>    <span class="n">lora_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span> <span class="c1"># PERF tuning</span>
<span class="linenos">269</span>        <span class="n">r</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="linenos">270</span>        <span class="n">lora_alpha</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
<span class="linenos">271</span>        <span class="n">target_modules</span><span class="o">=</span><span class="s2">&quot;all-linear&quot;</span><span class="p">,</span>
<span class="linenos">272</span>        <span class="n">lora_dropout</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
<span class="linenos">273</span>        <span class="n">bias</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="linenos">274</span>        <span class="n">task_type</span><span class="o">=</span><span class="n">TaskType</span><span class="o">.</span><span class="n">SEQ_2_SEQ_LM</span>
<span class="linenos">275</span>    <span class="p">)</span>
<span class="linenos">276</span>
<span class="linenos">277</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">lora_config</span><span class="p">)</span>
<span class="linenos">278</span>
<span class="linenos">279</span>    <span class="n">proj_ref</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">280</span>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;base_model&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> <span class="s2">&quot;proj&quot;</span><span class="p">):</span>
<span class="linenos">281</span>        <span class="n">proj_ref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">proj</span>
<span class="linenos">282</span>    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;proj&quot;</span><span class="p">):</span>
<span class="linenos">283</span>        <span class="n">proj_ref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">proj</span>
<span class="linenos">284</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">285</span>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Projection head not found; ensure Seq2SeqWProjection defines self.proj&quot;</span><span class="p">)</span>
<span class="linenos">286</span>
<span class="linenos">287</span>    <span class="c1"># Freezing all model parameters except LoRA adapters and projection head</span>
<span class="linenos">288</span>    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
<span class="linenos">289</span>        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">290</span>
<span class="linenos">291</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proj_ref</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<span class="linenos">292</span>        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">293</span>
<span class="linenos">294</span>    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
<span class="linenos">295</span>        <span class="k">if</span> <span class="s2">&quot;lora&quot;</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<span class="linenos">296</span>            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">297</span>
<span class="linenos">298</span>    
<span class="linenos">299</span>    <span class="n">model</span><span class="o">.</span><span class="n">print_trainable_parameters</span><span class="p">()</span> <span class="c1"># to verify only LoRA and proj are trainable</span>
<span class="linenos">300</span>    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<span class="linenos">301</span>    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">302</span>    
<span class="linenos">303</span>    <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DataCollatorForSeq2Seq</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> 
<span class="linenos">304</span>                                           <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<span class="linenos">305</span>                                           <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> 
<span class="linenos">306</span>                                           <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> 
<span class="linenos">307</span>                                           <span class="n">pad_to_multiple_of</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="linenos">308</span>
<span class="linenos">309</span>    <span class="n">training_args</span> <span class="o">=</span> <span class="n">Seq2SeqTrainingArguments</span><span class="p">(</span>
<span class="linenos">310</span>        <span class="n">output_dir</span><span class="o">=</span><span class="n">training_checkpoint_dir</span><span class="p">,</span>
<span class="linenos">311</span>        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="linenos">312</span>        <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="linenos">313</span>        <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># modified by epoch loop below</span>
<span class="linenos">314</span>        <span class="n">logging_dir</span><span class="o">=</span><span class="s2">&quot;./logs&quot;</span><span class="p">,</span>
<span class="linenos">315</span>        <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">316</span>        <span class="n">eval_strategy</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
<span class="linenos">317</span>        <span class="n">logging_strategy</span><span class="o">=</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span>
<span class="linenos">318</span>        <span class="n">logging_steps</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="linenos">319</span>        <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="linenos">320</span>        <span class="n">predict_with_generate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">321</span>        <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">322</span>        <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">323</span>        <span class="n">group_by_length</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">324</span>    <span class="p">)</span>
<span class="linenos">325</span>
<span class="linenos">326</span>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Seq2SeqTrainer</span><span class="p">(</span>
<span class="linenos">327</span>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">328</span>        <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
<span class="linenos">329</span>        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<span class="linenos">330</span>        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<span class="linenos">331</span>        <span class="n">processing_class</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos">332</span>        <span class="n">data_collator</span><span class="o">=</span><span class="n">data_collator</span><span class="p">,</span>
<span class="linenos">333</span>        <span class="n">compute_metrics</span><span class="o">=</span><span class="kc">None</span>
<span class="linenos">334</span>    <span class="p">)</span>
<span class="linenos">335</span>    
<span class="linenos">336</span>    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos">337</span>
<span class="linenos">338</span>    <span class="c1"># Summarization training halts every epoch to evaluate on ROUGE</span>
<span class="linenos">339</span>    <span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="linenos">340</span>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
<span class="linenos">341</span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">342</span>
<span class="linenos">343</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos">344</span>
<span class="linenos">345</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">training_checkpoint_dir</span><span class="si">}</span><span class="s2">/epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># saving checkpoint</span>
<span class="linenos">346</span>
<span class="linenos">347</span>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">rouge_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="c1"># all rouge metrics</span>
<span class="linenos">348</span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ROUGE-L:&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;rougeL&quot;</span><span class="p">])</span>
<span class="linenos">349</span>
<span class="linenos">350</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metric_dir</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos">351</span>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">metrics</span><span class="p">})</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">352</span>        
<span class="linenos">353</span>        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span> <span class="c1"># freeing GPU resources for training restart</span>
<span class="linenos">354</span>
<span class="linenos">355</span>    <span class="c1"># Saving base model and tokenizer</span>
<span class="linenos">356</span>    <span class="n">base_save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;base_model&quot;</span><span class="p">)</span>
<span class="linenos">357</span>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">358</span>    <span class="n">base_model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">base_save_dir</span><span class="p">)</span>
<span class="linenos">359</span>    <span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">base_save_dir</span><span class="p">)</span>
<span class="linenos">360</span>
<span class="linenos">361</span>    <span class="c1"># Saving PEFT weights</span>
<span class="linenos">362</span>    <span class="n">peft_save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;peft_model&quot;</span><span class="p">)</span>
<span class="linenos">363</span>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">peft_save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">364</span>    <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">peft_save_dir</span><span class="p">)</span>
<span class="linenos">365</span>
<span class="linenos">366</span>    <span class="c1"># Saving projection head weights separately</span>
<span class="linenos">367</span>    <span class="n">proj_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;proj.pt&quot;</span><span class="p">)</span>
<span class="linenos">368</span>    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">base_model</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">proj_path</span><span class="p">)</span>
<span class="linenos">369</span>
<span class="linenos">370</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved base model, tokenizer, PEFT weights, and projection head.&quot;</span><span class="p">)</span>
<span class="linenos">371</span>
<span class="linenos">372</span>
<span class="linenos">373</span><span class="c1">### Intent Targeting Training Pipeline ###</span>
<span class="linenos">374</span><span class="k">def</span><span class="w"> </span><span class="nf">intent_model_training</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">training_checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">375</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">376</span><span class="sd">    Training pipeline for intent targeting (between classification and summarization for now).</span>
<span class="linenos">377</span>
<span class="linenos">378</span><span class="sd">    Args:</span>
<span class="linenos">379</span><span class="sd">        data_dir (str): path to dataset being used for training</span>
<span class="linenos">380</span><span class="sd">        checkpoint (str): pre-trained HuggingFace model used for training</span>
<span class="linenos">381</span><span class="sd">        save_dir (str): path to saved PEFT weights for specified task</span>
<span class="linenos">382</span><span class="sd">        training_checkpoint_dir (str): directory to save in-training model config</span>
<span class="linenos">383</span><span class="sd">    </span>
<span class="linenos">384</span><span class="sd">    Returns:</span>
<span class="linenos">385</span><span class="sd">        None</span>
<span class="linenos">386</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">387</span>
<span class="linenos">388</span>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetDict</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">)</span>
<span class="linenos">389</span>
<span class="linenos">390</span>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
<span class="linenos">391</span>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span>
<span class="linenos">392</span>
<span class="linenos">393</span>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos">394</span>
<span class="linenos">395</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">label_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;label2id.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<span class="linenos">396</span>        <span class="n">label2id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="linenos">397</span>    
<span class="linenos">398</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">label_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;id2label.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<span class="linenos">399</span>        <span class="n">id2label</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="linenos">400</span>
<span class="linenos">401</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<span class="linenos">402</span>        <span class="n">checkpoint</span><span class="p">,</span>
<span class="linenos">403</span>        <span class="n">num_labels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">label2id</span><span class="p">),</span>
<span class="linenos">404</span>        <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">,</span>
<span class="linenos">405</span>        <span class="n">id2label</span><span class="o">=</span><span class="n">id2label</span>
<span class="linenos">406</span>    <span class="p">)</span>
<span class="linenos">407</span>
<span class="linenos">408</span>    <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DataCollatorWithPadding</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="linenos">409</span>
<span class="linenos">410</span>    <span class="n">metrics_logger</span> <span class="o">=</span> <span class="n">MetricsLoggerCallback</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">metric_dir</span><span class="p">)</span>
<span class="linenos">411</span>
<span class="linenos">412</span>    <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
<span class="linenos">413</span>        <span class="n">output_dir</span><span class="o">=</span><span class="n">training_checkpoint_dir</span><span class="p">,</span>
<span class="linenos">414</span>        <span class="n">eval_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">415</span>        <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">416</span>        <span class="n">logging_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
<span class="linenos">417</span>        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="linenos">418</span>        <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="linenos">419</span>        <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="linenos">420</span>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
<span class="linenos">421</span>        <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
<span class="linenos">422</span>        <span class="n">warmup_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="linenos">423</span>        <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">424</span>        <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span>
<span class="linenos">425</span>    <span class="p">)</span>
<span class="linenos">426</span>
<span class="linenos">427</span>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
<span class="linenos">428</span>        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">429</span>        <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
<span class="linenos">430</span>        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<span class="linenos">431</span>        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<span class="linenos">432</span>        <span class="n">processing_class</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="linenos">433</span>        <span class="n">data_collator</span><span class="o">=</span><span class="n">data_collator</span><span class="p">,</span>
<span class="linenos">434</span>        <span class="n">compute_metrics</span><span class="o">=</span><span class="n">intent_compute_metrics</span><span class="p">,</span>
<span class="linenos">435</span>        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">metrics_logger</span><span class="p">]</span>
<span class="linenos">436</span>    <span class="p">)</span>
<span class="linenos">437</span>
<span class="linenos">438</span>    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos">439</span>
<span class="linenos">440</span>    <span class="n">model</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">441</span>    <span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">442</span>
<span class="linenos">443</span>
<span class="linenos">444</span>
<span class="linenos">445</span>
<span class="linenos">446</span>
<span class="linenos">447</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<span class="linenos">  2</span>    <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">hamming_loss</span><span class="p">,</span>
<span class="linenos">  3</span>    <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="linenos">  4</span><span class="p">)</span>
<span class="linenos">  5</span><span class="kn">from</span><span class="w"> </span><span class="nn">evaluate</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
<span class="linenos">  6</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainerCallback</span><span class="p">,</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="p">,</span> <span class="n">AutoTokenizer</span>
<span class="linenos">  7</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.training_args</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">TrainerState</span><span class="p">,</span> <span class="n">TrainerControl</span><span class="p">,</span> <span class="n">EvalPrediction</span>
<span class="linenos">  8</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="linenos">  9</span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos"> 10</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos"> 11</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 12</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos"> 13</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos"> 14</span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="linenos"> 15</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="k">class</span><span class="w"> </span><span class="nc">MetricsLoggerCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>
<span class="linenos"> 20</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 21</span><span class="sd">    Custom HuggingFace Callback designed to save metrics during training after every epoch as</span>
<span class="linenos"> 22</span><span class="sd">    a new json file. Accounts for multiple training runs without overwritting data.</span>
<span class="linenos"> 23</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 24</span>    
<span class="linenos"> 25</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="linenos"> 26</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 27</span>        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
<span class="linenos"> 28</span>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 29</span>        <span class="bp">self</span><span class="o">.</span><span class="n">run_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TrainerState</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">TrainerControl</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 32</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">        Event called at the end of an evaluation phase to dump the metrics into a JSON file.</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span><span class="sd">        Args:</span>
<span class="linenos"> 36</span><span class="sd">            args (TrainingArguments): training arguments</span>
<span class="linenos"> 37</span><span class="sd">            state (TrainerState): current state of the trainer</span>
<span class="linenos"> 38</span><span class="sd">            control (TrainerControl): trainer control</span>
<span class="linenos"> 39</span><span class="sd">            metrics (Dict[str, float], optional): evaluation metrics. Defaults to None.</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="sd">        Returns:</span>
<span class="linenos"> 42</span><span class="sd">            None</span>
<span class="linenos"> 43</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 44</span>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 45</span>            <span class="k">return</span>
<span class="linenos"> 46</span>        
<span class="linenos"> 47</span>        <span class="n">run_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;run_counter&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 48</span>        <span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">epoch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">global_step</span>
<span class="linenos"> 49</span>        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metrics_run</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">_epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">.json&quot;</span>
<span class="linenos"> 50</span>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos"> 53</span>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="k">class</span><span class="w"> </span><span class="nc">CUDACleanupCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>
<span class="linenos"> 56</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 57</span><span class="sd">    Custom HuggingFace Callback designed to release unoccupied GPU resources at the end of each</span>
<span class="linenos"> 58</span><span class="sd">    epoch. Hopefully minimizes OOM errors.</span>
<span class="linenos"> 59</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 60</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">TrainerState</span><span class="p">,</span> <span class="n">control</span><span class="p">:</span> <span class="n">TrainerControl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainerControl</span><span class="p">:</span>
<span class="linenos"> 61</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 62</span><span class="sd">        Event called at the end of an epoch to clear the CUDA cache.</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="sd">        Args:</span>
<span class="linenos"> 65</span><span class="sd">            args (TrainingArguments): training arguments</span>
<span class="linenos"> 66</span><span class="sd">            state (TrainerState): current state of the trainer</span>
<span class="linenos"> 67</span><span class="sd">            control (TrainerControl): trainer control</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="sd">        Returns:</span>
<span class="linenos"> 70</span><span class="sd">            TrainerControl: trainer control</span>
<span class="linenos"> 71</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 72</span>        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="linenos"> 73</span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Memory Cleanup] GPU cache cleared at end of epoch </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 74</span>        <span class="k">return</span> <span class="n">control</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="k">def</span><span class="w"> </span><span class="nf">classification_compute_metric</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">:</span> <span class="n">EvalPrediction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 78</span><span class="sd">    Method for use in model training to evaluation performance. Includes accuracy, F1 (micro &amp; macro), precision, recall, hamming loss and ROC-AUC (micro &amp; macro)</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="sd">    Args:</span>
<span class="linenos"> 81</span><span class="sd">        eval_preds (transformers.EvalPrediction): logits and labels for computing metrics</span>
<span class="linenos"> 82</span><span class="sd">    </span>
<span class="linenos"> 83</span><span class="sd">    Returns:</span>
<span class="linenos"> 84</span><span class="sd">        dict[str:float]: metrics based on evaluations</span>
<span class="linenos"> 85</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 86</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="linenos"> 87</span>        <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_preds</span>
<span class="linenos"> 88</span>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 89</span>        <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_preds</span><span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">],</span> <span class="n">eval_preds</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
<span class="linenos"> 90</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 91</span>        <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_preds</span><span class="o">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">eval_preds</span><span class="o">.</span><span class="n">label_ids</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>    <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="linenos"> 94</span>    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span>    <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">over</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
<span class="linenos"> 99</span>        <span class="n">probs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">logits</span><span class="p">))</span>
<span class="linenos">100</span>    <span class="n">preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="linenos">101</span>
<span class="linenos">102</span>    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
<span class="linenos">105</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;f1_micro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">106</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;f1_macro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">107</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;precision_micro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">108</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;recall_micro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">109</span>    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;hamming_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hamming_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
<span class="linenos">110</span>
<span class="linenos">111</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">112</span>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;roc_auc_micro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">)</span>
<span class="linenos">113</span>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;roc_auc_macro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">)</span>
<span class="linenos">114</span>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
<span class="linenos">115</span>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC-AUC not computed: </span><span class="si">{</span><span class="n">ve</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">116</span>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;roc_auc_micro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
<span class="linenos">117</span>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;roc_auc_macro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
<span class="linenos">118</span>    
<span class="linenos">119</span>    <span class="k">return</span> <span class="n">metrics</span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="k">def</span><span class="w"> </span><span class="nf">rouge_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">max_gen_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="linenos">122</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">123</span><span class="sd">    Used to evaluate the summarization model on ROUGE between epochs using the current checkpoint.</span>
<span class="linenos">124</span><span class="sd">    Substitute for running evaluations during model training (GPU resource conservation)</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="sd">    Args:</span>
<span class="linenos">127</span><span class="sd">        model (transformers.AutoModelForSeq2SeqLM): model being evaluated</span>
<span class="linenos">128</span><span class="sd">        dataset (Dataset): validation dataset</span>
<span class="linenos">129</span><span class="sd">        tokenizer (transformers.AutoTokenizer): tokenizer associated with model</span>
<span class="linenos">130</span><span class="sd">        batch_size (int): size of evaluation batch</span>
<span class="linenos">131</span><span class="sd">        device (str): device for evaluation (&quot;cuda&quot; or &quot;cpu&quot;)</span>
<span class="linenos">132</span><span class="sd">        max_gen_length (int): max number of tokens generated for prediction</span>
<span class="linenos">133</span><span class="sd">    </span>
<span class="linenos">134</span><span class="sd">    Returns:</span>
<span class="linenos">135</span><span class="sd">        dict[str:float]: rouge metrics</span>
<span class="linenos">136</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">137</span>    <span class="n">rouge</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s2">&quot;rouge&quot;</span><span class="p">)</span>
<span class="linenos">138</span>    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">139</span>    
<span class="linenos">140</span>    <span class="n">preds</span><span class="p">,</span> <span class="n">refs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="linenos">141</span>
<span class="linenos">142</span>    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">disable_adapter</span><span class="p">():</span>
<span class="linenos">143</span>        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="linenos">144</span>        <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">145</span>
<span class="linenos">146</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)):</span>
<span class="linenos">147</span>            <span class="n">batch</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
<span class="linenos">148</span>            <span class="n">input_texts</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;discharge_note&quot;</span><span class="p">]</span>
<span class="linenos">149</span>            <span class="n">reference_texts</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
<span class="linenos">150</span>
<span class="linenos">151</span>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
<span class="linenos">152</span>                <span class="n">input_texts</span><span class="p">,</span>
<span class="linenos">153</span>                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
<span class="linenos">154</span>                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">155</span>                <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
<span class="linenos">156</span>                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">157</span>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">158</span>        
<span class="linenos">159</span>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> 
<span class="linenos">160</span>                                    <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">max_gen_length</span><span class="p">,</span>
<span class="linenos">161</span>                                    <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">162</span>                                    <span class="n">pad_token_id</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
<span class="linenos">163</span>        
<span class="linenos">164</span>            <span class="n">decoded_preds</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">165</span>            <span class="n">decoded_refs</span> <span class="o">=</span> <span class="n">reference_texts</span>
<span class="linenos">166</span>
<span class="linenos">167</span>            <span class="n">preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_preds</span><span class="p">)</span>
<span class="linenos">168</span>            <span class="n">refs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">decoded_refs</span><span class="p">)</span>
<span class="linenos">169</span>
<span class="linenos">170</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">rouge</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">preds</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">refs</span><span class="p">,</span> <span class="n">use_stemmer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">171</span>    <span class="k">return</span> <span class="n">result</span>
<span class="linenos">172</span>
<span class="linenos">173</span><span class="k">def</span><span class="w"> </span><span class="nf">intent_compute_metrics</span><span class="p">(</span><span class="n">eva_pred</span><span class="p">:</span> <span class="n">EvalPrediction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="linenos">174</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">175</span><span class="sd">    Method for use in model training to evaluation performance. Includes accuracy.</span>
<span class="linenos">176</span>
<span class="linenos">177</span><span class="sd">    Args:</span>
<span class="linenos">178</span><span class="sd">        eval_preds (transformers.EvalPrediction): logits and labels for computing metrics</span>
<span class="linenos">179</span><span class="sd">    </span>
<span class="linenos">180</span><span class="sd">    Returns:</span>
<span class="linenos">181</span><span class="sd">        dict[str:float]: metrics based on evaluations</span>
<span class="linenos">182</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">183</span>    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eva_pred</span>
<span class="linenos">186</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">187</span>    <span class="k">return</span> <span class="n">accuracy</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Multi-model Biomedical LLM</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="code_reference.html">Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_pipeline.html">Data Preprocessing Pipeline</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Training Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="inference_pipeline.html">Inference Pipeline</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="data_pipeline.html" title="previous chapter">Data Preprocessing Pipeline</a></li>
      <li>Next: <a href="inference_pipeline.html" title="next chapter">Inference Pipeline</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Alexander Nicholson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/training_pipeline.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>