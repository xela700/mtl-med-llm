<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data Preprocessing Pipeline &#8212; Multi-model Biomedical LLM  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Training Pipeline" href="training_pipeline.html" />
    <link rel="prev" title="Code Reference" href="code_reference.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="data-preprocessing-pipeline">
<h1>Data Preprocessing Pipeline<a class="headerlink" href="#data-preprocessing-pipeline" title="Link to this heading">¶</a></h1>
<p>This document outlines the data preprocessing steps used to convert raw clinical notes into formats
suitable for training LLMs. It also includes code for creating summary targets for training the
summarization model.</p>
<p>Also included are the prompt creator classes and functions used to construct the intention model’s dataset.</p>
<section id="source-code">
<h2>Source Code<a class="headerlink" href="#source-code" title="Link to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Script to preprocess data for model training for both ICD classification</span>
<span class="linenos">  3</span><span class="sd">and clinical note summarization.</span>
<span class="linenos">  4</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  5</span>
<span class="linenos">  6</span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="linenos">  7</span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="linenos">  8</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos">  9</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 10</span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="linenos"> 11</span><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="linenos"> 12</span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="linenos"> 13</span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos"> 14</span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="linenos"> 15</span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 16</span><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DatasetDict</span>
<span class="linenos"> 17</span><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="linenos"> 18</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">AutoModelForSeq2SeqLM</span>
<span class="linenos"> 19</span><span class="kn">from</span><span class="w"> </span><span class="nn">transformers.tokenization_utils_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreTrainedTokenizerBase</span>
<span class="linenos"> 20</span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="linenos"> 21</span><span class="kn">from</span><span class="w"> </span><span class="nn">iterstrat.ml_stratifiers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultilabelStratifiedShuffleSplit</span>
<span class="linenos"> 22</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="k">class</span><span class="w"> </span><span class="nc">TextPreprocessor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="linenos"> 28</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 29</span><span class="sd">    Parent class for preprocessing text imported from dataset.</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="sd">    Attributes:</span>
<span class="linenos"> 32</span><span class="sd">        tokenizer (PreTrainedTokenizerBase): The associated HuggingFace model. Must match model used in training.</span>
<span class="linenos"> 33</span><span class="sd">        text_col (str): Column that contains the text to be cleaned and tokenized</span>
<span class="linenos"> 34</span><span class="sd">        remove_sections (list[str]): Optional section headers used to remove sections of clinical</span>
<span class="linenos"> 35</span><span class="sd">        notes. Default of &#39;None&#39; results in removal of sections that will always be blank due to </span>
<span class="linenos"> 36</span><span class="sd">        de-identification</span>
<span class="linenos"> 37</span><span class="sd">        cleaned_path (str): path string for saving cleaned dataset</span>
<span class="linenos"> 38</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="s2">&quot;text_col&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_sections&quot;</span><span class="p">,</span> <span class="s2">&quot;cleaned_path&quot;</span><span class="p">)</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 43</span>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_tokenizer</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos"> 44</span>        <span class="bp">self</span><span class="o">.</span><span class="n">text_col</span> <span class="o">=</span> <span class="n">text_col</span>
<span class="linenos"> 45</span>        <span class="bp">self</span><span class="o">.</span><span class="n">remove_sections</span> <span class="o">=</span> <span class="n">remove_sections</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span> <span class="o">=</span> <span class="n">cleaned_path</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>    
<span class="linenos"> 49</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">:</span>
<span class="linenos"> 50</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 51</span><span class="sd">        Initializes the tokenizer to be used in preprocessing.</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="sd">        Args:</span>
<span class="linenos"> 54</span><span class="sd">            checkpoint (str): Checkpoint to be used to determine the model. Must be the </span>
<span class="linenos"> 55</span><span class="sd">            same as the checkpoint used in training.</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="sd">        Returns:</span>
<span class="linenos"> 58</span><span class="sd">            PreTrainedTokenizerBase: tokenizer for the model</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="sd">        Raises:</span>
<span class="linenos"> 61</span><span class="sd">            ValueError/OSError: if checkpoint provided does not exist or is inaccessible</span>
<span class="linenos"> 62</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 65</span>            <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos"> 66</span>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<span class="linenos"> 67</span>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to access model using checkpoint </span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 68</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to access model using checkpoint </span><span class="si">{</span><span class="n">checkpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
<span class="linenos"> 69</span>        
<span class="linenos"> 70</span>        <span class="k">return</span> <span class="n">tokenizer</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_blank_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos"> 73</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 74</span><span class="sd">        Removed redacted sections from MIMIC data that occur as a result of the</span>
<span class="linenos"> 75</span><span class="sd">        deindentification process.</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="sd">        Args:</span>
<span class="linenos"> 78</span><span class="sd">            note (str): clinical note to be stripped of unneeded sections</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="sd">        Returns:</span>
<span class="linenos"> 81</span><span class="sd">            str: clinical note stripped of blank sections</span>
<span class="linenos"> 82</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 85</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default removable sections to remove always de-identified sections.&quot;</span><span class="p">)</span>
<span class="linenos"> 86</span>            <span class="bp">self</span><span class="o">.</span><span class="n">remove_sections</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 87</span>                <span class="s2">&quot;Name:&quot;</span><span class="p">,</span> <span class="s2">&quot;Unit No:&quot;</span><span class="p">,</span> <span class="s2">&quot;Admission Date:&quot;</span><span class="p">,</span> 
<span class="linenos"> 88</span>                <span class="s2">&quot;Discharge Date:&quot;</span><span class="p">,</span> <span class="s2">&quot;Date of Birth&quot;</span><span class="p">,</span> <span class="s2">&quot;Attending:&quot;</span><span class="p">,</span>
<span class="linenos"> 89</span>                <span class="s2">&quot;Social History:&quot;</span><span class="p">,</span> <span class="s2">&quot;Followup Instructions:&quot;</span><span class="p">,</span> <span class="s2">&quot;Facility:&quot;</span> 
<span class="linenos"> 90</span>            <span class="p">]</span>
<span class="linenos"> 91</span>        
<span class="linenos"> 92</span>        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 93</span>        <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 94</span>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span>        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
<span class="linenos"> 97</span>            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;=+\s*&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="linenos">100</span>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">101</span>                <span class="k">continue</span>
<span class="linenos">102</span>
<span class="linenos">103</span>            <span class="c1"># Detection of removable headers</span>
<span class="linenos">104</span>            <span class="n">has_header</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_sections</span><span class="p">)</span>
<span class="linenos">105</span>
<span class="linenos">106</span>            <span class="c1"># Checks for redactions on same/next line</span>
<span class="linenos">107</span>            <span class="n">is_redacted_line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<span class="linenos">108</span>            <span class="n">is_redacted_next</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_+\s*&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="linenos">109</span>
<span class="linenos">110</span>            <span class="c1"># Removes redactable sections</span>
<span class="linenos">111</span>            <span class="k">if</span> <span class="n">has_header</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_redacted_line</span> <span class="ow">or</span> <span class="n">is_redacted_next</span><span class="p">):</span>
<span class="linenos">112</span>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">is_redacted_next</span> <span class="k">else</span> <span class="mi">1</span>
<span class="linenos">113</span>                <span class="k">continue</span>
<span class="linenos">114</span>            <span class="c1"># Section kept otherwise</span>
<span class="linenos">115</span>            <span class="n">cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="linenos">116</span>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos">117</span>        
<span class="linenos">118</span>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
<span class="linenos">119</span>    
<span class="linenos">120</span>
<span class="linenos">121</span>    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_deidentified_blanks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">122</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">123</span><span class="sd">        Inserts standard placeholder text inplace of de-identified blanks where applicable.</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="sd">        Args:</span>
<span class="linenos">126</span><span class="sd">            text (str): Input text w/ de-identified blanks from MIMIC notes</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="sd">        Returns:</span>
<span class="linenos">129</span><span class="sd">            str: Text w/ replacement placeholders for training</span>
<span class="linenos">130</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">131</span>
<span class="linenos">132</span>        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">133</span>            <span class="sa">r</span><span class="s2">&quot;\b_{2,}\s*(years?\s*old|y\.?o\.?|y/o|yo)&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;AGE&gt;&quot;</span><span class="p">,</span>
<span class="linenos">134</span>            <span class="sa">r</span><span class="s2">&quot;\b_{2,}-years?-old\b&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;AGE&gt;&quot;</span><span class="p">,</span>
<span class="linenos">135</span>            <span class="sa">r</span><span class="s2">&quot;\b(mrs?|ms)\.?\s_{2,}&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;PATIENT&gt;&quot;</span><span class="p">,</span>
<span class="linenos">136</span>            <span class="sa">r</span><span class="s2">&quot;\b(doctor|dr.?)\s_{2,}&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;DOCTOR&gt;&quot;</span><span class="p">,</span>
<span class="linenos">137</span>
<span class="linenos">138</span>        <span class="p">}</span>
<span class="linenos">139</span>
<span class="linenos">140</span>        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">141</span>            <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="linenos">142</span>        
<span class="linenos">143</span>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b_{2,}\b&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;REDACTED&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="c1"># Clean up for remaining unknown de-identified fields</span>
<span class="linenos">144</span>        <span class="k">return</span> <span class="n">text</span>
<span class="linenos">145</span>
<span class="linenos">146</span>    <span class="nd">@abstractmethod</span>
<span class="linenos">147</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">148</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">149</span><span class="sd">        Full preprocess pipeline for specific task. Takes a dataframe, cleans it, applies tokenization and filtering where applicable,</span>
<span class="linenos">150</span><span class="sd">        and saves it to a new location for use during model training.</span>
<span class="linenos">151</span>
<span class="linenos">152</span><span class="sd">        Args:</span>
<span class="linenos">153</span><span class="sd">            dataframe (pd.DataFrame): data to undergo preprocessing.</span>
<span class="linenos">154</span><span class="sd">        </span>
<span class="linenos">155</span><span class="sd">        Returns:</span>
<span class="linenos">156</span><span class="sd">            None</span>
<span class="linenos">157</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">158</span>        <span class="k">pass</span>
<span class="linenos">159</span>    
<span class="linenos">160</span>
<span class="linenos">161</span><span class="k">class</span><span class="w"> </span><span class="nc">ClassificationPreprocessor</span><span class="p">(</span><span class="n">TextPreprocessor</span><span class="p">):</span>
<span class="linenos">162</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">163</span><span class="sd">    Preprocessor child class for classification training pipeline for use with encoder models.</span>
<span class="linenos">164</span><span class="sd">    Requires labels (ICD-10 codes) paired with input text.</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="sd">    Attributes:</span>
<span class="linenos">167</span><span class="sd">        label_ids (dict[str:int]): Separate label-specific query. Current plan to use initial dataset and group by</span>
<span class="linenos">168</span><span class="sd">        ICD-10 codes. Only training on most frequent 2k - 5k codes (out of 70k) to reduce chance of no relevant</span>
<span class="linenos">169</span><span class="sd">        samples.</span>
<span class="linenos">170</span><span class="sd">        label_col (str): Column in the full dataset that contains the ICD-10 labels for a given clinical note.</span>
<span class="linenos">171</span><span class="sd">        extract_sections (list[str]): Sections of full text most relevant for classification.</span>
<span class="linenos">172</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">173</span>
<span class="linenos">174</span>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;label_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;extract_sections&quot;</span><span class="p">,</span> <span class="s2">&quot;label_col&quot;</span><span class="p">,</span> <span class="s2">&quot;data_collator&quot;</span><span class="p">)</span>
<span class="linenos">175</span>
<span class="linenos">176</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_ids</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">:</span><span class="nb">int</span><span class="p">],</span> <span class="n">text_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extract_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">177</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="n">text_col</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="o">=</span><span class="n">cleaned_path</span><span class="p">,</span> <span class="n">remove_sections</span><span class="o">=</span><span class="n">remove_sections</span><span class="p">)</span>
<span class="linenos">178</span>        <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="o">=</span> <span class="n">extract_sections</span>
<span class="linenos">179</span>        <span class="bp">self</span><span class="o">.</span><span class="n">label_ids</span> <span class="o">=</span> <span class="n">label_ids</span>
<span class="linenos">180</span>        <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span> <span class="o">=</span> <span class="n">label_col</span>
<span class="linenos">181</span>
<span class="linenos">182</span>    <span class="k">def</span><span class="w"> </span><span class="nf">classification_extract_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="linenos">183</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">184</span><span class="sd">        Captures relevant sections for ICD code classification. Used to limit the input size of a given sample while minimizing</span>
<span class="linenos">185</span><span class="sd">        context loss. Only intended for classification task and not summarization.</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="sd">        Args:</span>
<span class="linenos">188</span><span class="sd">            text (str): Input discharge notes with extractable sections</span>
<span class="linenos">189</span><span class="sd">            sections (list[str]): sections to keep from text. If none provided, a default set is used</span>
<span class="linenos">190</span>
<span class="linenos">191</span><span class="sd">        Returns:</span>
<span class="linenos">192</span><span class="sd">            str: Extracted sections from text joined together </span>
<span class="linenos">193</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">194</span>
<span class="linenos">195</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">196</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default sections to extract data for classification.&quot;</span><span class="p">)</span>
<span class="linenos">197</span>            <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;discharge diagnosis&#39;</span><span class="p">,</span> <span class="s1">&#39;brief hospital course&#39;</span><span class="p">,</span> <span class="s1">&#39;hospital course&#39;</span><span class="p">,</span>
<span class="linenos">198</span>                        <span class="s1">&#39;final diagnosis&#39;</span><span class="p">,</span> <span class="s1">&#39;principal diagnosis&#39;</span><span class="p">,</span> <span class="s1">&#39;primary diagnosis&#39;</span><span class="p">,</span> <span class="s1">&#39;history of present illness&#39;</span><span class="p">]</span>
<span class="linenos">199</span>        
<span class="linenos">200</span>        <span class="c1"># Normalize section names for comparison</span>
<span class="linenos">201</span>        <span class="n">target_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span><span class="p">]</span>
<span class="linenos">202</span>
<span class="linenos">203</span>        <span class="c1"># Find all sections with their content</span>
<span class="linenos">204</span>        <span class="n">section_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="linenos">205</span>            <span class="sa">r</span><span class="s1">&#39;(?i)(?P&lt;header&gt;^[A-Z][A-Z \-/]{3,}):\s*\n(?P&lt;body&gt;.*?)(?=^[A-Z][A-Z \-/]{3,}:|\Z)&#39;</span><span class="p">,</span>
<span class="linenos">206</span>            <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
<span class="linenos">207</span>        <span class="p">)</span>
<span class="linenos">208</span>
<span class="linenos">209</span>        <span class="n">extracted</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">210</span>
<span class="linenos">211</span>        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">section_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="linenos">212</span>            <span class="n">header</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">213</span>            <span class="n">body</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">214</span>
<span class="linenos">215</span>            <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">target_sections</span><span class="p">:</span>
<span class="linenos">216</span>                <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
<span class="linenos">219</span>    
<span class="linenos">220</span>
<span class="linenos">221</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="linenos">222</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">223</span><span class="sd">        Preprocess function to be mapped using dataset specific to classification task.</span>
<span class="linenos">224</span><span class="sd">        To be used with dataset.map() method.</span>
<span class="linenos">225</span>
<span class="linenos">226</span><span class="sd">        Args:</span>
<span class="linenos">227</span><span class="sd">            batch (dict[list[str]]): batch from dataset</span>
<span class="linenos">228</span>
<span class="linenos">229</span><span class="sd">        Returns:</span>
<span class="linenos">230</span><span class="sd">            dict[str:list[int]]: Modified data in dataset. Text field tokenized based on tokenizer. Multi-hot label vectors created using top k labels.</span>
<span class="linenos">231</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">232</span>
<span class="linenos">233</span>        <span class="n">processed_texts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">234</span>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]:</span>
<span class="linenos">235</span>            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_blank_sections</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">236</span>            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_deidentified_blanks</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">237</span>            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classification_extract_sections</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">238</span>            <span class="n">processed_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">239</span>
<span class="linenos">240</span>        <span class="n">tokenized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">processed_texts</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">241</span>
<span class="linenos">242</span>        <span class="n">multi_hot_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">243</span>
<span class="linenos">244</span>        <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">]:</span>
<span class="linenos">245</span>            <span class="n">label_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_ids</span><span class="p">)</span>
<span class="linenos">246</span>            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
<span class="linenos">247</span>                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<span class="linenos">248</span>                <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">249</span>                    <span class="n">label_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">250</span>            <span class="n">multi_hot_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_vector</span><span class="p">)</span>
<span class="linenos">251</span>
<span class="linenos">252</span>        <span class="c1"># check to ensure label count matches batch size</span>
<span class="linenos">253</span>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_hot_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]),</span> <span class="s2">&quot;Label count doesn&#39;t match batch size!&quot;</span>
<span class="linenos">254</span>
<span class="linenos">255</span>        <span class="n">tokenized_data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_hot_labels</span>
<span class="linenos">256</span>
<span class="linenos">257</span>        <span class="k">return</span> <span class="n">tokenized_data</span>
<span class="linenos">258</span>    
<span class="linenos">259</span>
<span class="linenos">260</span>    <span class="k">def</span><span class="w"> </span><span class="nf">filter_text_by_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="linenos">261</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">262</span><span class="sd">        Filtering method to check for the presence of one (or more) ICD labels that are being used during</span>
<span class="linenos">263</span><span class="sd">        training. To be used with dataset.filter() method</span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="sd">        Args:</span>
<span class="linenos">266</span><span class="sd">            batch (dict[str:list[str]]): dataset batch being provided to check for label presence</span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="sd">        Returns:</span>
<span class="linenos">269</span><span class="sd">            list[bool]: true if at least one label is present. filtered represents booleans that determine whether</span>
<span class="linenos">270</span><span class="sd">            a note stays or gets dropped. </span>
<span class="linenos">271</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">272</span>        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">273</span>        <span class="k">for</span> <span class="n">icd_codes</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<span class="linenos">274</span>            <span class="n">keep</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_ids</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">icd_codes</span><span class="p">)</span>
<span class="linenos">275</span>            <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
<span class="linenos">276</span>        <span class="k">return</span> <span class="n">filtered</span>
<span class="linenos">277</span>    
<span class="linenos">278</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iterative_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">min_inactive</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="linenos">279</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">280</span><span class="sd">        Performs iterative sampling on multi-label classification dataset to sample it down from full dataset to a more manageable size.</span>
<span class="linenos">281</span>
<span class="linenos">282</span><span class="sd">        Args:</span>
<span class="linenos">283</span><span class="sd">            dataframe (pd.DataFrame): dataframe to sample down</span>
<span class="linenos">284</span><span class="sd">            target_size (int): target size of the final dataset</span>
<span class="linenos">285</span><span class="sd">            min_inactive (int): the minimum amount of samples with inactive labels (codes)</span>
<span class="linenos">286</span><span class="sd">            random_state (int): seed determination for random sampling</span>
<span class="linenos">287</span><span class="sd">        </span>
<span class="linenos">288</span><span class="sd">        Returns:</span>
<span class="linenos">289</span><span class="sd">            pd.DataFrame: dataframe after sampling</span>
<span class="linenos">290</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">291</span>
<span class="linenos">292</span>        <span class="c1"># Label vocabulary</span>
<span class="linenos">293</span>        <span class="n">all_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">label</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">})</span>
<span class="linenos">294</span>        <span class="n">active_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="linenos">295</span>        <span class="n">active_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">active_labels</span><span class="p">)</span>
<span class="linenos">296</span>        <span class="n">inactive_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">active_set</span>
<span class="linenos">297</span>
<span class="linenos">298</span>        <span class="k">if</span> <span class="n">inactive_set</span><span class="p">:</span>
<span class="linenos">299</span>            <span class="n">max_allowed</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">inactive_set</span><span class="p">)</span>
<span class="linenos">300</span>            <span class="n">min_inactive</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_inactive</span><span class="p">,</span> <span class="n">max_allowed</span><span class="p">)</span>
<span class="linenos">301</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">302</span>            <span class="n">min_inactive</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">303</span>
<span class="linenos">304</span>        <span class="c1"># Matrix for labels being trained on</span>
<span class="linenos">305</span>        <span class="n">label_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active_labels</span><span class="p">)}</span>
<span class="linenos">306</span>        <span class="n">y_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_labels</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="linenos">307</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">]):</span>
<span class="linenos">308</span>            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
<span class="linenos">309</span>                <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">active_set</span><span class="p">:</span>
<span class="linenos">310</span>                    <span class="n">y_active</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos">311</span>        
<span class="linenos">312</span>        <span class="c1"># Collecting indices to ensure some inactive labels remain</span>
<span class="linenos">313</span>        <span class="n">guaranteed_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">314</span>        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
<span class="linenos">315</span>        <span class="k">if</span> <span class="n">inactive_set</span><span class="p">:</span>
<span class="linenos">316</span>            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">inactive_set</span><span class="p">:</span>
<span class="linenos">317</span>                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">])</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
<span class="linenos">318</span>                <span class="k">if</span> <span class="n">indices</span><span class="p">:</span>
<span class="linenos">319</span>                    <span class="n">chosen</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">min_inactive</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">320</span>                    <span class="n">guaranteed_indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>
<span class="linenos">321</span>        
<span class="linenos">322</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guaranteed_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">target_size</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">:</span>
<span class="linenos">323</span>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Inactive sampling taking &gt;30</span><span class="si">% o</span><span class="s2">f dataset, trimming...&quot;</span><span class="p">)</span>
<span class="linenos">324</span>            <span class="n">guaranteed_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">guaranteed_indices</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">target_size</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="linenos">325</span>        
<span class="linenos">326</span>        <span class="c1"># Iterative stratification</span>
<span class="linenos">327</span>        <span class="n">remaining_target_size</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">guaranteed_indices</span><span class="p">)</span>
<span class="linenos">328</span>        <span class="k">if</span> <span class="n">remaining_target_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">329</span>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;target_size too small compared to min_inactive.&quot;</span><span class="p">)</span>
<span class="linenos">330</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_size too small compared to min_inactive.&quot;</span><span class="p">)</span>
<span class="linenos">331</span>        
<span class="linenos">332</span>        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">))</span>
<span class="linenos">333</span>
<span class="linenos">334</span>        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="linenos">335</span>        <span class="k">if</span> <span class="n">remaining_target_size</span> <span class="o">&gt;=</span> <span class="n">n_samples</span><span class="p">:</span>
<span class="linenos">336</span>            <span class="n">train_size</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos">337</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">338</span>            <span class="n">train_size</span> <span class="o">=</span> <span class="n">remaining_target_size</span> <span class="o">/</span> <span class="n">n_samples</span>
<span class="linenos">339</span>        
<span class="linenos">340</span>        <span class="k">if</span> <span class="n">train_size</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
<span class="linenos">341</span>            <span class="n">test_size</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">342</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">343</span>            <span class="n">test_size</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">train_size</span>
<span class="linenos">344</span>
<span class="linenos">345</span>        <span class="n">msss</span> <span class="o">=</span> <span class="n">MultilabelStratifiedShuffleSplit</span><span class="p">(</span>
<span class="linenos">346</span>            <span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">347</span>            <span class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span class="p">,</span>
<span class="linenos">348</span>            <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
<span class="linenos">349</span>            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
<span class="linenos">350</span>        <span class="p">)</span>
<span class="linenos">351</span>        <span class="n">strat_indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">msss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_active</span><span class="p">))</span>
<span class="linenos">352</span>
<span class="linenos">353</span>        <span class="n">selected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">strat_indices</span><span class="p">)</span> <span class="o">|</span> <span class="n">guaranteed_indices</span>
<span class="linenos">354</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">target_size</span><span class="p">:</span>
<span class="linenos">355</span>            <span class="n">selected</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">selected</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">target_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">356</span>        
<span class="linenos">357</span>        <span class="k">return</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">selected</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">358</span>
<span class="linenos">359</span>
<span class="linenos">360</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">361</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">362</span><span class="sd">        Full preprocess steps for classification. Renames columns to appropriate names.</span>
<span class="linenos">363</span><span class="sd">        Converts dataframe to a dataset. Filters samples without any applicable training labels.</span>
<span class="linenos">364</span><span class="sd">        Maps preprocess function. Finally, saves dataset to disk for reuse.</span>
<span class="linenos">365</span>
<span class="linenos">366</span><span class="sd">        Args:</span>
<span class="linenos">367</span><span class="sd">            dataframe (pd.DataFrame): full dataframe for classification preprocessing</span>
<span class="linenos">368</span><span class="sd">        </span>
<span class="linenos">369</span><span class="sd">        Returns:</span>
<span class="linenos">370</span><span class="sd">            None</span>
<span class="linenos">371</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">372</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_col</span> <span class="o">!=</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
<span class="linenos">373</span>            <span class="n">dataframe</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">374</span>            <span class="bp">self</span><span class="o">.</span><span class="n">text_col</span> <span class="o">=</span> <span class="s2">&quot;input&quot;</span>
<span class="linenos">375</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span> <span class="o">!=</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span>
<span class="linenos">376</span>            <span class="n">dataframe</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_col</span><span class="p">:</span> <span class="s2">&quot;labels&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">377</span>            <span class="bp">self</span><span class="o">.</span><span class="n">label_col</span> <span class="o">=</span> <span class="s2">&quot;labels&quot;</span>
<span class="linenos">378</span>
<span class="linenos">379</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
<span class="linenos">380</span>
<span class="linenos">381</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_text_by_label</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">382</span>
<span class="linenos">383</span>        <span class="c1"># Modified code to reduce number of samples</span>
<span class="linenos">384</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="linenos">385</span>        <span class="n">subset_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterative_sampling</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="linenos">386</span>
<span class="linenos">387</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">subset_df</span><span class="p">)</span>
<span class="linenos">388</span>
<span class="linenos">389</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">390</span>
<span class="linenos">391</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="p">):</span>
<span class="linenos">392</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="si">}</span><span class="s2"> exists and will be overwritten with new cleaned dataset.&quot;</span><span class="p">)</span>
<span class="linenos">393</span>        
<span class="linenos">394</span>        <span class="n">clean_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="p">)</span>
<span class="linenos">395</span>
<span class="linenos">396</span>        <span class="c1"># Deletes old dataset to prevent conflits</span>
<span class="linenos">397</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">clean_path</span><span class="p">):</span>
<span class="linenos">398</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting old dataset at </span><span class="si">{</span><span class="n">clean_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">399</span>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">clean_path</span><span class="p">)</span>
<span class="linenos">400</span>
<span class="linenos">401</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clean_path</span><span class="p">))</span>
<span class="linenos">402</span>
<span class="linenos">403</span>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
<span class="linenos">404</span>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_directory</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">405</span>            
<span class="linenos">406</span>
<span class="linenos">407</span>
<span class="linenos">408</span><span class="k">class</span><span class="w"> </span><span class="nc">SummarizationPreprocessor</span><span class="p">(</span><span class="n">TextPreprocessor</span><span class="p">):</span>
<span class="linenos">409</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">410</span><span class="sd">    Preprocessor for summarization task for use with encoder-decoder models. </span>
<span class="linenos">411</span><span class="sd">    Requires target summaries for training.</span>
<span class="linenos">412</span><span class="sd">    Current plan to mix section within clinical notes that most resembles a summary with synthetic </span>
<span class="linenos">413</span><span class="sd">    summaries generated by an LLM.</span>
<span class="linenos">414</span>
<span class="linenos">415</span><span class="sd">    Attributes:</span>
<span class="linenos">416</span><span class="sd">        target_col (str): summary targets in the dataframe</span>
<span class="linenos">417</span><span class="sd">        source_type_col (str): tracking column for whether the summary target is &#39;real&#39; (pulled from data) or &#39;synthetic&#39; (generated by LLM)</span>
<span class="linenos">418</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">419</span>
<span class="linenos">420</span>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;target_col&quot;</span><span class="p">,</span> <span class="s2">&quot;source_type_col&quot;</span><span class="p">)</span>
<span class="linenos">421</span>
<span class="linenos">422</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_type_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">423</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="n">text_col</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="o">=</span><span class="n">cleaned_path</span><span class="p">,</span> <span class="n">remove_sections</span><span class="o">=</span><span class="n">remove_sections</span><span class="p">)</span>
<span class="linenos">424</span>        <span class="bp">self</span><span class="o">.</span><span class="n">target_col</span> <span class="o">=</span> <span class="n">target_col</span>
<span class="linenos">425</span>        <span class="bp">self</span><span class="o">.</span><span class="n">source_type_col</span> <span class="o">=</span> <span class="n">source_type_col</span>
<span class="linenos">426</span>
<span class="linenos">427</span>    
<span class="linenos">428</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="linenos">429</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">430</span><span class="sd">        Preprocess function to be mapped using dataset specific to summarization task.</span>
<span class="linenos">431</span><span class="sd">        To be used with dataset.map() method.</span>
<span class="linenos">432</span>
<span class="linenos">433</span><span class="sd">        Args:</span>
<span class="linenos">434</span><span class="sd">            batch (dict[list[str]]): batch from dataset</span>
<span class="linenos">435</span>
<span class="linenos">436</span><span class="sd">        Returns:</span>
<span class="linenos">437</span><span class="sd">            dict[str:list[str]]: Modified data in dataset. Text field tokenized based on tokenizer. Multi-hot label vectors created using top k labels.</span>
<span class="linenos">438</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">439</span>        <span class="n">input_text</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span>
<span class="linenos">440</span>        <span class="n">target_text</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_col</span><span class="p">]</span>
<span class="linenos">441</span>
<span class="linenos">442</span>        <span class="c1"># preprocess input text (i.e. entire clinical notes)</span>
<span class="linenos">443</span>        <span class="n">tokenized_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span> 
<span class="linenos">444</span>            <span class="n">input_text</span><span class="p">,</span>
<span class="linenos">445</span>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">446</span>            <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span>
<span class="linenos">447</span>        <span class="p">)</span>
<span class="linenos">448</span>
<span class="linenos">449</span>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">as_target_tokenizer</span><span class="p">():</span> <span class="c1"># preprocess target text (i.e. summaries)</span>
<span class="linenos">450</span>            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
<span class="linenos">451</span>                <span class="n">target_text</span><span class="p">,</span>
<span class="linenos">452</span>                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">453</span>                <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span>
<span class="linenos">454</span>            <span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
<span class="linenos">455</span>
<span class="linenos">456</span>        <span class="n">tokenized_data</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
<span class="linenos">457</span>        <span class="k">return</span> <span class="n">tokenized_data</span>
<span class="linenos">458</span>    
<span class="linenos">459</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">460</span>        
<span class="linenos">461</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
<span class="linenos">462</span>
<span class="linenos">463</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="p">[])</span>
<span class="linenos">464</span>
<span class="linenos">465</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="p">):</span>
<span class="linenos">466</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="si">}</span><span class="s2"> exists and will be overwritten with new cleaned dataset.&quot;</span><span class="p">)</span>
<span class="linenos">467</span>
<span class="linenos">468</span>        <span class="n">clean_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="p">)</span>
<span class="linenos">469</span>
<span class="linenos">470</span>        <span class="c1"># Deletes old dataset to prevent conflits</span>
<span class="linenos">471</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">clean_path</span><span class="p">):</span>
<span class="linenos">472</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting old dataset at </span><span class="si">{</span><span class="n">clean_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">473</span>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">clean_path</span><span class="p">)</span>
<span class="linenos">474</span>
<span class="linenos">475</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clean_path</span><span class="p">))</span>
<span class="linenos">476</span>
<span class="linenos">477</span>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
<span class="linenos">478</span>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_directory</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">479</span>
<span class="linenos">480</span>
<span class="linenos">481</span><span class="k">class</span><span class="w"> </span><span class="nc">SummarizationTargetCreation</span><span class="p">(</span><span class="n">TextPreprocessor</span><span class="p">):</span>
<span class="linenos">482</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">483</span><span class="sd">    Preprocessor for raw data intended for summarization. Used to clean data and prepare for input into LLM to create synthetic targets.</span>
<span class="linenos">484</span>
<span class="linenos">485</span><span class="sd">    Attributes:</span>
<span class="linenos">486</span><span class="sd">        extract_sections (list[str]): section from text to be extracted for use as real training targets</span>
<span class="linenos">487</span><span class="sd">        real_target_path (str): path to save real summary data</span>
<span class="linenos">488</span><span class="sd">        synthetic_target_path (str): path to save synthetic summary data</span>
<span class="linenos">489</span><span class="sd">        model (AutoModel): model for generating synthetic summaries (uses same checkpoint)</span>
<span class="linenos">490</span><span class="sd">        device (int): GPU or CPU for summary generation. Will use GPU if available.</span>
<span class="linenos">491</span><span class="sd">        summarizer (pipeline): pipeline for generating summaries</span>
<span class="linenos">492</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">493</span>
<span class="linenos">494</span>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;extract_sections&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="s2">&quot;summarizer&quot;</span><span class="p">,</span> <span class="s2">&quot;real_target_path&quot;</span><span class="p">,</span> <span class="s2">&quot;synthetic_target_path&quot;</span><span class="p">)</span>
<span class="linenos">495</span>
<span class="linenos">496</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">real_target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">synthetic_target_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extract_sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">497</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="n">text_col</span><span class="p">,</span> <span class="n">cleaned_path</span><span class="o">=</span><span class="n">cleaned_path</span><span class="p">,</span> <span class="n">remove_sections</span><span class="o">=</span><span class="n">remove_sections</span><span class="p">)</span>
<span class="linenos">498</span>        <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="o">=</span> <span class="n">extract_sections</span>
<span class="linenos">499</span>        <span class="bp">self</span><span class="o">.</span><span class="n">real_target_path</span> <span class="o">=</span> <span class="n">real_target_path</span>
<span class="linenos">500</span>        <span class="bp">self</span><span class="o">.</span><span class="n">synthetic_target_path</span> <span class="o">=</span> <span class="n">synthetic_target_path</span>
<span class="linenos">501</span>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="linenos">502</span>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos">503</span>        <span class="bp">self</span><span class="o">.</span><span class="n">summarizer</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s2">&quot;summarization&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">504</span>
<span class="linenos">505</span>
<span class="linenos">506</span>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_from_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extract_section_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">507</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">508</span><span class="sd">        Helper function for extract_target. Extracts sections from text and returns them if they exist in a combined </span>
<span class="linenos">509</span><span class="sd">        format. (Only one should exist)</span>
<span class="linenos">510</span>
<span class="linenos">511</span><span class="sd">        Args:</span>
<span class="linenos">512</span><span class="sd">            text (str): text to have portion(s) extracted</span>
<span class="linenos">513</span><span class="sd">            extract_sections (list[str]): section(s) being extracted from text</span>
<span class="linenos">514</span>
<span class="linenos">515</span><span class="sd">        Returns:</span>
<span class="linenos">516</span><span class="sd">            str: text from extracted sections</span>
<span class="linenos">517</span><span class="sd">            None: returns nothing if section doesn&#39;t exist</span>
<span class="linenos">518</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">519</span>
<span class="linenos">520</span>
<span class="linenos">521</span>        <span class="c1"># Normalize section names for comparison</span>
<span class="linenos">522</span>        <span class="n">target_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">extract_section_list</span><span class="p">]</span>
<span class="linenos">523</span>
<span class="linenos">524</span>        <span class="c1"># Find all sections with their content</span>
<span class="linenos">525</span>        <span class="n">section_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="linenos">526</span>            <span class="sa">r</span><span class="s1">&#39;(?i)(?P&lt;header&gt;^[A-Z][A-Z \-/]{3,}):\s*\n(?P&lt;body&gt;.*?)(?=^[A-Z][A-Z \-/]{3,}:|\Z)&#39;</span><span class="p">,</span>
<span class="linenos">527</span>            <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
<span class="linenos">528</span>        <span class="p">)</span>
<span class="linenos">529</span>
<span class="linenos">530</span>        <span class="n">extracted</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">531</span>
<span class="linenos">532</span>        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">section_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="linenos">533</span>            <span class="n">header</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos">534</span>            <span class="n">body</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">535</span>
<span class="linenos">536</span>            <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">target_sections</span><span class="p">:</span>
<span class="linenos">537</span>                <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="linenos">538</span>        
<span class="linenos">539</span>        <span class="n">combined</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span>
<span class="linenos">540</span>
<span class="linenos">541</span>        <span class="k">return</span> <span class="n">combined</span> <span class="k">if</span> <span class="n">combined</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos">542</span>
<span class="linenos">543</span>
<span class="linenos">544</span>    <span class="k">def</span><span class="w"> </span><span class="nf">extract_real_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">545</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">546</span><span class="sd">        Takes a training dataframe and pulls out section intended to represent a target summarization.</span>
<span class="linenos">547</span><span class="sd">        This dataframe is not to be used for creating synthetic targets.</span>
<span class="linenos">548</span>
<span class="linenos">549</span><span class="sd">        Args:</span>
<span class="linenos">550</span><span class="sd">            dataframe (pd.DataFrame): Dataframe with only text (SEPARATE FROM SYNTHETIC DF) -&gt; to have representative summary extracted</span>
<span class="linenos">551</span><span class="sd">            save_path (str): Path to save dataframe with real summary targets</span>
<span class="linenos">552</span><span class="sd">        </span>
<span class="linenos">553</span><span class="sd">        Returns:</span>
<span class="linenos">554</span><span class="sd">            None</span>
<span class="linenos">555</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">556</span>
<span class="linenos">557</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">558</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default section(s) to extract target data.&quot;</span><span class="p">)</span>
<span class="linenos">559</span>            <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;brief hospital course&quot;</span><span class="p">,</span> <span class="s2">&quot;hospital course&quot;</span><span class="p">]</span>
<span class="linenos">560</span>        
<span class="linenos">561</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="linenos">562</span>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_from_text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_sections</span><span class="p">))</span>
<span class="linenos">563</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span> <span class="c1"># Removes samples w/o any applicable sections</span>
<span class="linenos">564</span>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;source_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;real&quot;</span> <span class="c1"># Targets are &quot;real&quot; in that they come from the data</span>
<span class="linenos">565</span>
<span class="linenos">566</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
<span class="linenos">567</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data already exists at </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">. Overwritting.&quot;</span><span class="p">)</span>
<span class="linenos">568</span>
<span class="linenos">569</span>        <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="linenos">570</span>
<span class="linenos">571</span>    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_parquet_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="linenos">572</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">573</span><span class="sd">        Helper function to determine if filepath is a valid parquet file</span>
<span class="linenos">574</span>
<span class="linenos">575</span><span class="sd">        Args:</span>
<span class="linenos">576</span><span class="sd">            path (str): path to parquet file</span>
<span class="linenos">577</span><span class="sd">        </span>
<span class="linenos">578</span><span class="sd">        Returns:</span>
<span class="linenos">579</span><span class="sd">            bool: True if valid parquet file lives at path</span>
<span class="linenos">580</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">581</span>        <span class="kn">import</span><span class="w"> </span><span class="nn">fastparquet</span>
<span class="linenos">582</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">583</span>            <span class="n">_</span> <span class="o">=</span> <span class="n">fastparquet</span><span class="o">.</span><span class="n">ParquetFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="linenos">584</span>            <span class="k">return</span> <span class="kc">True</span>
<span class="linenos">585</span>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">586</span>            <span class="k">return</span> <span class="kc">False</span>
<span class="linenos">587</span>    
<span class="linenos">588</span>    <span class="k">def</span><span class="w"> </span><span class="nf">summarize_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">min_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos">589</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">590</span><span class="sd">        Provides a list of texts to the summarizing LLM and returns a decoded list of output summaries.</span>
<span class="linenos">591</span>
<span class="linenos">592</span><span class="sd">        Args:</span>
<span class="linenos">593</span><span class="sd">            texts (list[str]): texts to summarize</span>
<span class="linenos">594</span><span class="sd">            max_length (int): max number of tokens to output</span>
<span class="linenos">595</span><span class="sd">            min_length (int): min number of tokens to output</span>
<span class="linenos">596</span><span class="sd">        </span>
<span class="linenos">597</span><span class="sd">        Returns:</span>
<span class="linenos">598</span><span class="sd">            list[str]: decoded target summaries</span>
<span class="linenos">599</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">600</span>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
<span class="linenos">601</span>            <span class="n">texts</span><span class="p">,</span>
<span class="linenos">602</span>            <span class="n">max_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
<span class="linenos">603</span>            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
<span class="linenos">604</span>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">605</span>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
<span class="linenos">606</span>            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">607</span>        
<span class="linenos">608</span>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<span class="linenos">609</span>            <span class="n">output_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<span class="linenos">610</span>                <span class="n">input_ids</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span>
<span class="linenos">611</span>                <span class="n">attention_mask</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span>
<span class="linenos">612</span>                <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
<span class="linenos">613</span>                <span class="n">min_length</span><span class="o">=</span><span class="n">min_length</span><span class="p">,</span>
<span class="linenos">614</span>                <span class="n">do_sample</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">615</span>            <span class="p">)</span>
<span class="linenos">616</span>        
<span class="linenos">617</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">output_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">618</span>
<span class="linenos">619</span>
<span class="linenos">620</span>    
<span class="linenos">621</span>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synthetic_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">622</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">623</span><span class="sd">        Takes training input and generates synthetic summaries using a pretrained medical LLM (checkpoint).</span>
<span class="linenos">624</span><span class="sd">        Generates in chunks to limit chance of interruptions.</span>
<span class="linenos">625</span>
<span class="linenos">626</span><span class="sd">        Args:</span>
<span class="linenos">627</span><span class="sd">            dataframe (pd.DataFrame): Dataframe with only text (SEPARATE FROM REAL DF) -&gt; to have summary generated</span>
<span class="linenos">628</span><span class="sd">            chunk_size (int): Number of rows processed at a time</span>
<span class="linenos">629</span><span class="sd">            save_path (str): Path where the summaries will be saved</span>
<span class="linenos">630</span><span class="sd">            resume (bool): If True, will skip rows with generated summaries</span>
<span class="linenos">631</span><span class="sd">        </span>
<span class="linenos">632</span><span class="sd">        Returns:</span>
<span class="linenos">633</span><span class="sd">            None</span>
<span class="linenos">634</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">635</span>
<span class="linenos">636</span>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">637</span>            <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span>
<span class="linenos">638</span>
<span class="linenos">639</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
<span class="linenos">640</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data exists at </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> for new generation. Overwritting data.&quot;</span><span class="p">)</span>
<span class="linenos">641</span>
<span class="linenos">642</span>        <span class="k">if</span> <span class="n">resume</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
<span class="linenos">643</span>            <span class="n">df_summaries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="linenos">644</span>            <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_summaries</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="linenos">645</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming summary generation from file. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows already generated.&quot;</span><span class="p">)</span>
<span class="linenos">646</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">647</span>            <span class="n">df_summaries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="linenos">648</span>            <span class="n">processed_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">649</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting summary generation using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">650</span>
<span class="linenos">651</span>        <span class="c1"># Loop to generate summaries in chunks to help protect completed work</span>
<span class="linenos">652</span>        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Summarizing&quot;</span><span class="p">):</span>
<span class="linenos">653</span>            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">))</span>
<span class="linenos">654</span>            <span class="n">chunk</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># current chunk being summarized</span>
<span class="linenos">655</span>
<span class="linenos">656</span>            <span class="k">if</span> <span class="n">resume</span><span class="p">:</span>
<span class="linenos">657</span>                <span class="c1"># Only using ids that don&#39;t exist in current save</span>
<span class="linenos">658</span>                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="o">~</span><span class="n">chunk</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">processed_ids</span><span class="p">)]</span>
<span class="linenos">659</span>                <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<span class="linenos">660</span>                    <span class="k">continue</span>
<span class="linenos">661</span>            
<span class="linenos">662</span>            <span class="n">texts</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">663</span>
<span class="linenos">664</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting summarization for rows </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="linenos">665</span>
<span class="linenos">666</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">667</span>                <span class="n">summaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize_batch</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
<span class="linenos">668</span>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed summarization for rows </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">669</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">670</span>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summarization failed for rows </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">671</span>                <span class="k">raise</span> <span class="n">e</span>
<span class="linenos">672</span>            <span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span>
<span class="linenos">673</span>            
<span class="linenos">674</span>            <span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;source_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;synthetic&quot;</span> <span class="c1"># Targets are synthetic in that they are generated</span>
<span class="linenos">675</span>            
<span class="linenos">676</span>            <span class="n">file_exists_and_valid</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_parquet_file</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="linenos">677</span>
<span class="linenos">678</span>            <span class="n">chunk</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
<span class="linenos">679</span>                <span class="n">save_path</span><span class="p">,</span> 
<span class="linenos">680</span>                <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;fastparquet&#39;</span><span class="p">,</span> 
<span class="linenos">681</span>                <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<span class="linenos">682</span>                <span class="n">append</span><span class="o">=</span><span class="n">file_exists_and_valid</span>
<span class="linenos">683</span>                <span class="p">)</span>
<span class="linenos">684</span>
<span class="linenos">685</span>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">686</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">687</span><span class="sd">        Cleans text by removing sections that are always blank and inserting representative placeholders in remaining blanks.</span>
<span class="linenos">688</span><span class="sd">        Breaks data up to generate real and sythetic summaries.</span>
<span class="linenos">689</span><span class="sd">        This preprocess method saves two separate parquet files, one for extracted &quot;real&quot; targets and one for synthetically-created targets</span>
<span class="linenos">690</span>
<span class="linenos">691</span><span class="sd">        Args:</span>
<span class="linenos">692</span><span class="sd">            dataframe (pd.DataFrame): to clean and prepare for summary generation</span>
<span class="linenos">693</span><span class="sd">            save_dir (str): path to save the tokenizer configuration to</span>
<span class="linenos">694</span><span class="sd">        </span>
<span class="linenos">695</span><span class="sd">        Returns:</span>
<span class="linenos">696</span><span class="sd">            None</span>
<span class="linenos">697</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">698</span>        <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_blank_sections</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos">699</span>        <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_deidentified_blanks</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="linenos">700</span>
<span class="linenos">701</span>        <span class="n">data_for_real_targets</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="linenos">702</span>        <span class="n">data_for_synthetic_targets</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data_for_real_targets</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="linenos">703</span>
<span class="linenos">704</span>        <span class="n">data_for_real_targets</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_target_path</span><span class="p">)</span>
<span class="linenos">705</span>        <span class="n">data_for_synthetic_targets</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synthetic_target_path</span><span class="p">)</span>
<span class="linenos">706</span>
<span class="linenos">707</span>        <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
<span class="linenos">708</span>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">save_directory</span><span class="o">=</span><span class="n">save_dir</span><span class="p">)</span>
<span class="linenos">709</span>    
<span class="linenos">710</span>    <span class="k">def</span><span class="w"> </span><span class="nf">combine_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_summary_dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">synthetic_summary_dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">711</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">712</span><span class="sd">        Requires real and synthetic targets created and saved in applicable locations. Unites both datasets to finalize summary preprocessing in preparation for</span>
<span class="linenos">713</span><span class="sd">        model training. Goal is to use an equal number of real and synthetic targets for training.</span>
<span class="linenos">714</span>
<span class="linenos">715</span><span class="sd">        Args:</span>
<span class="linenos">716</span><span class="sd">            real_summary_dataset (pd.DataFrame): Dataframe with real summary targets</span>
<span class="linenos">717</span><span class="sd">            synthetic_summary_dataset (pd.DataFrame): Dataframe with synthetic summary targets</span>
<span class="linenos">718</span><span class="sd">        </span>
<span class="linenos">719</span><span class="sd">        Returns:</span>
<span class="linenos">720</span><span class="sd">            None</span>
<span class="linenos">721</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">722</span>
<span class="linenos">723</span>        <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">real_summary_dataset</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">synthetic_summary_dataset</span><span class="p">))</span>
<span class="linenos">724</span>
<span class="linenos">725</span>        <span class="n">real_summary_trimmed</span> <span class="o">=</span> <span class="n">real_summary_dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">min_length</span><span class="p">)</span>
<span class="linenos">726</span>        <span class="n">synthetic_summary_trimmed</span> <span class="o">=</span> <span class="n">synthetic_summary_dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">min_length</span><span class="p">)</span>
<span class="linenos">727</span>
<span class="linenos">728</span>        <span class="n">combined_summary_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">real_summary_trimmed</span><span class="p">,</span> <span class="n">synthetic_summary_trimmed</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">729</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving combined data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">730</span>        <span class="n">combined_summary_dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_path</span><span class="p">)</span>
<span class="linenos">731</span>
<span class="linenos">732</span>
<span class="linenos">733</span><span class="k">class</span><span class="w"> </span><span class="nc">IntentDataPreprocessor</span><span class="p">:</span>
<span class="linenos">734</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">735</span><span class="sd">    Alternate preprocessor for the intent targeting model. Uses custom-made prompts mixed with real text.</span>
<span class="linenos">736</span>
<span class="linenos">737</span><span class="sd">    Attributes:</span>
<span class="linenos">738</span><span class="sd">        tokenizer (AutoTokenizer): tokenizer for model</span>
<span class="linenos">739</span><span class="sd">        label2id (dict[str:int]): labels to ids</span>
<span class="linenos">740</span><span class="sd">        id2label(dict[int:str]): ids to labels</span>
<span class="linenos">741</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">742</span>
<span class="linenos">743</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">744</span>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="linenos">745</span>        <span class="bp">self</span><span class="o">.</span><span class="n">label2id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;classification&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;summarization&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="linenos">746</span>        <span class="bp">self</span><span class="o">.</span><span class="n">id2label</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;classification&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;summarization&quot;</span><span class="p">}</span>
<span class="linenos">747</span>    
<span class="linenos">748</span>    <span class="k">def</span><span class="w"> </span><span class="nf">build_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">val_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">749</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">750</span><span class="sd">        Uses the created intent targeting dataset to build a tokenized dataset for training use.</span>
<span class="linenos">751</span>
<span class="linenos">752</span><span class="sd">        Args:</span>
<span class="linenos">753</span><span class="sd">            intent_data (pd.DataFrame): intent targeting dataframe</span>
<span class="linenos">754</span><span class="sd">            save_path (str): path to save dataset to</span>
<span class="linenos">755</span><span class="sd">            test_size (float): size of test dataset</span>
<span class="linenos">756</span><span class="sd">            val_size (float): size of val dataset</span>
<span class="linenos">757</span><span class="sd">            seed (int): seed for randomization</span>
<span class="linenos">758</span><span class="sd">        </span>
<span class="linenos">759</span><span class="sd">        Returns:</span>
<span class="linenos">760</span><span class="sd">            DatasetDict: Hugging Face compatible dataset dictionary for training</span>
<span class="linenos">761</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">762</span>
<span class="linenos">763</span>        <span class="n">intent_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intent_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label2id</span><span class="p">)</span>
<span class="linenos">764</span>        <span class="n">intent_data</span> <span class="o">=</span> <span class="n">intent_data</span><span class="p">[[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]]</span>
<span class="linenos">765</span>
<span class="linenos">766</span>        <span class="n">train_df</span><span class="p">,</span> <span class="n">temp_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
<span class="linenos">767</span>            <span class="n">intent_data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">intent_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="linenos">768</span>        <span class="p">)</span>
<span class="linenos">769</span>
<span class="linenos">770</span>        <span class="n">rel_val_size</span> <span class="o">=</span> <span class="n">val_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">test_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="p">)</span>
<span class="linenos">771</span>
<span class="linenos">772</span>        <span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
<span class="linenos">773</span>            <span class="n">temp_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rel_val_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">temp_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="linenos">774</span>        <span class="p">)</span>
<span class="linenos">775</span>
<span class="linenos">776</span>        <span class="n">train_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
<span class="linenos">777</span>        <span class="n">val_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">val_df</span><span class="p">)</span>
<span class="linenos">778</span>        <span class="n">test_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
<span class="linenos">779</span>
<span class="linenos">780</span>        <span class="k">def</span><span class="w"> </span><span class="nf">encode_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="linenos">781</span>            <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
<span class="linenos">782</span>                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<span class="linenos">783</span>                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">784</span>                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
<span class="linenos">785</span>                <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span>
<span class="linenos">786</span>            <span class="p">)</span>
<span class="linenos">787</span>
<span class="linenos">788</span>            <span class="n">encoded</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
<span class="linenos">789</span>
<span class="linenos">790</span>            <span class="k">return</span> <span class="n">encoded</span>
<span class="linenos">791</span>        
<span class="linenos">792</span>        <span class="n">train_ds</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">encode_batch</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="n">train_ds</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
<span class="linenos">793</span>        <span class="n">val_ds</span> <span class="o">=</span> <span class="n">val_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">encode_batch</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="n">val_ds</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
<span class="linenos">794</span>        <span class="n">test_ds</span> <span class="o">=</span> <span class="n">test_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">encode_batch</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_columns</span><span class="o">=</span><span class="n">test_ds</span><span class="o">.</span><span class="n">column_names</span><span class="p">)</span>
<span class="linenos">795</span>
<span class="linenos">796</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">DatasetDict</span><span class="p">({</span>
<span class="linenos">797</span>            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_ds</span><span class="p">,</span>
<span class="linenos">798</span>            <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="n">val_ds</span><span class="p">,</span>
<span class="linenos">799</span>            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_ds</span>
<span class="linenos">800</span>        <span class="p">})</span>
<span class="linenos">801</span>
<span class="linenos">802</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<span class="linenos">803</span>    
<span class="linenos">804</span>    <span class="k">def</span><span class="w"> </span><span class="nf">save_label_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">805</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">806</span><span class="sd">        Saves label mappings for model use. Creates json files for label2id and id2label</span>
<span class="linenos">807</span>
<span class="linenos">808</span><span class="sd">        save_path (str): path to save label mappings to</span>
<span class="linenos">809</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">810</span>
<span class="linenos">811</span>        <span class="n">Path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">812</span>
<span class="linenos">813</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;label2id.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos">814</span>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label2id</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="linenos">815</span>        
<span class="linenos">816</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;id2label.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="linenos">817</span>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id2label</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="linenos">818</span>
<span class="linenos">819</span>        
<span class="linenos">820</span>        
<span class="linenos">821</span>        
<span class="linenos">822</span>
<span class="linenos">823</span>
<span class="linenos">824</span>        
<span class="linenos">825</span>    
<span class="linenos">826</span>    
<span class="linenos">827</span>
<span class="linenos">828</span>    
<span class="linenos">829</span>
<span class="linenos">830</span>
<span class="linenos">831</span>
<span class="linenos">832</span>    
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Script to create a series of prompts to train intent targetting model.</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="sd">Modification of original prompt creating preprocessor that uses premuation of verb phrases, modifiers, targets, and suffixes to create a diverse set of prompts</span>
<span class="linenos">  5</span><span class="sd">along with ambiguous prompts, instead of prepending prompts to clinical notes. Added robustness and noise intended to make intent-targeting model better able</span>
<span class="linenos">  6</span><span class="sd">to generalize.</span>
<span class="linenos">  7</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="linenos"> 10</span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="linenos"> 11</span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="linenos"> 12</span><span class="kn">from</span><span class="w"> </span><span class="nn">data.fetch_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_data</span>
<span class="linenos"> 13</span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="k">class</span><span class="w"> </span><span class="nc">PromptCreator</span><span class="p">:</span>
<span class="linenos"> 16</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 17</span><span class="sd">    Class to construct prompts for generating an intent-targeting dataset</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="sd">    Attributes:</span>
<span class="linenos"> 20</span><span class="sd">        summarize_verbs (list[str]): list of summarization intended verb phrases</span>
<span class="linenos"> 21</span><span class="sd">        classify_verbs (list[str]): list of classification intended verb phrases</span>
<span class="linenos"> 22</span><span class="sd">        modifiers (list[str]): list of politeness phrases</span>
<span class="linenos"> 23</span><span class="sd">        targets (list[str]): list of object-based phrases</span>
<span class="linenos"> 24</span><span class="sd">        suffixes (list[str]): list of potential sentence suffixes</span>
<span class="linenos"> 25</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
<span class="linenos"> 28</span>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span>        <span class="bp">self</span><span class="o">.</span><span class="n">summarize_verbs</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 31</span>            <span class="s2">&quot;summarize&quot;</span><span class="p">,</span> <span class="s2">&quot;provide a summary of&quot;</span><span class="p">,</span> <span class="s2">&quot;briefly summarize&quot;</span><span class="p">,</span> <span class="s2">&quot;give a brief summary of&quot;</span><span class="p">,</span> <span class="s2">&quot;outline&quot;</span><span class="p">,</span> <span class="s2">&quot;condense&quot;</span><span class="p">,</span> <span class="s2">&quot;shorten&quot;</span>
<span class="linenos"> 32</span>        <span class="p">]</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span>        <span class="bp">self</span><span class="o">.</span><span class="n">classify_verbs</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 35</span>            <span class="s2">&quot;classify&quot;</span><span class="p">,</span> <span class="s2">&quot;categorize&quot;</span><span class="p">,</span> <span class="s2">&quot;identify ICD codes for&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;assign codes to&quot;</span><span class="p">,</span> <span class="s2">&quot;find potential ICD codes for&quot;</span><span class="p">,</span> <span class="s2">&quot;categorize&quot;</span><span class="p">,</span> <span class="s2">&quot;give medical diagnosis&quot;</span><span class="p">,</span> <span class="s2">&quot;provide codes for&quot;</span>
<span class="linenos"> 36</span>        <span class="p">]</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 39</span>            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;please&quot;</span><span class="p">,</span> <span class="s2">&quot;can you&quot;</span><span class="p">,</span> <span class="s2">&quot;could you&quot;</span><span class="p">,</span> <span class="s2">&quot;kindly&quot;</span><span class="p">,</span> <span class="s2">&quot;would you mind&quot;</span><span class="p">,</span> <span class="s2">&quot;I need you to&quot;</span><span class="p">,</span> <span class="s2">&quot;help me&quot;</span>
<span class="linenos"> 40</span>        <span class="p">]</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span>        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 43</span>            <span class="s2">&quot;this note&quot;</span><span class="p">,</span> <span class="s2">&quot;the following text&quot;</span><span class="p">,</span> <span class="s2">&quot;the content below&quot;</span><span class="p">,</span> <span class="s2">&quot;this clinical note&quot;</span><span class="p">,</span> <span class="s2">&quot;the text provided&quot;</span>
<span class="linenos"> 44</span>        <span class="p">]</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 47</span>            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;for me&quot;</span><span class="p">,</span> <span class="s2">&quot;if possible&quot;</span><span class="p">,</span> <span class="s2">&quot;when you can&quot;</span><span class="p">,</span> <span class="s2">&quot;if you can&quot;</span><span class="p">,</span> <span class="s2">&quot;please&quot;</span><span class="p">,</span> <span class="s2">&quot;as soon as possible&quot;</span>
<span class="linenos"> 48</span>        <span class="p">]</span>
<span class="linenos"> 49</span>    
<span class="linenos"> 50</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 51</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 52</span><span class="sd">        Builds list of unique NLP prompts for intent targeting</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="sd">        Args:</span>
<span class="linenos"> 55</span><span class="sd">            verbs (List[str]): list of task-specific verb phrases to use in prompt generation</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="sd">        Returns:</span>
<span class="linenos"> 58</span><span class="sd">            List[str]: list of unique prompts</span>
<span class="linenos"> 59</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 60</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span>        <span class="k">for</span> <span class="n">verb</span><span class="p">,</span> <span class="n">modifier</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">verbs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffixes</span><span class="p">):</span>
<span class="linenos"> 63</span>            <span class="k">if</span> <span class="n">modifier</span><span class="p">:</span>
<span class="linenos"> 64</span>                <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos"> 65</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 66</span>                <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">verb</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos"> 67</span>            
<span class="linenos"> 68</span>            <span class="n">prompts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span>            <span class="k">if</span> <span class="n">modifier</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;can you&quot;</span><span class="p">,</span> <span class="s2">&quot;could you&quot;</span><span class="p">,</span> <span class="s2">&quot;would you mind&quot;</span><span class="p">]:</span>
<span class="linenos"> 71</span>                <span class="n">question</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos"> 72</span>                <span class="n">prompts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="linenos"> 73</span>            
<span class="linenos"> 74</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">})</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
<span class="linenos"> 77</span>        <span class="k">return</span> <span class="n">prompts</span>
<span class="linenos"> 78</span>    
<span class="linenos"> 79</span>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_summarization_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 81</span><span class="sd">        Generates prompts specific to summarization</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="sd">        Args:</span>
<span class="linenos"> 84</span><span class="sd">            limit (int | None): Limit the number of potential premutations</span>
<span class="linenos"> 85</span><span class="sd">        </span>
<span class="linenos"> 86</span><span class="sd">        Returns:</span>
<span class="linenos"> 87</span><span class="sd">            list[str]: List of premutations</span>
<span class="linenos"> 88</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 89</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summarize_verbs</span><span class="p">)</span>
<span class="linenos"> 90</span>        <span class="k">return</span> <span class="n">prompts</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">prompts</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_classification_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 94</span><span class="sd">        Generates prompts specific to classification</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="sd">        Args:</span>
<span class="linenos"> 97</span><span class="sd">            limit (int | None): Limit the number of potential premutations</span>
<span class="linenos"> 98</span><span class="sd">        </span>
<span class="linenos"> 99</span><span class="sd">        Returns:</span>
<span class="linenos">100</span><span class="sd">            list[str]: List of premutations</span>
<span class="linenos">101</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">102</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classify_verbs</span><span class="p">)</span>
<span class="linenos">103</span>        <span class="k">return</span> <span class="n">prompts</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">prompts</span>
<span class="linenos">104</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="k">class</span><span class="w"> </span><span class="nc">NeutralPromptCreator</span><span class="p">:</span>
<span class="linenos">107</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">108</span><span class="sd">    Creates neutral (no target) prompts to vary data for intent targeting model</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="sd">    Attributes:</span>
<span class="linenos">111</span><span class="sd">        neutral_verbs (list[str]): list of neutral verb phrases</span>
<span class="linenos">112</span><span class="sd">        modifiers (list[str]): list of politeness phrases</span>
<span class="linenos">113</span><span class="sd">        targets (list[str]): list of object-based phrases</span>
<span class="linenos">114</span><span class="sd">        suffixes (list[str]): list of potential sentence suffixes</span>
<span class="linenos">115</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">116</span>
<span class="linenos">117</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">118</span>        <span class="bp">self</span><span class="o">.</span><span class="n">neutral_verbs</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">119</span>            <span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;look at&quot;</span><span class="p">,</span> <span class="s2">&quot;review&quot;</span><span class="p">,</span> <span class="s2">&quot;analyze&quot;</span><span class="p">,</span> <span class="s2">&quot;help me with&quot;</span><span class="p">,</span> <span class="s2">&quot;work with&quot;</span><span class="p">,</span> <span class="s2">&quot;handle&quot;</span>
<span class="linenos">120</span>        <span class="p">]</span>
<span class="linenos">121</span>
<span class="linenos">122</span>        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">123</span>            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;please&quot;</span><span class="p">,</span> <span class="s2">&quot;can you&quot;</span><span class="p">,</span> <span class="s2">&quot;could you&quot;</span><span class="p">,</span> <span class="s2">&quot;kindly&quot;</span><span class="p">,</span> <span class="s2">&quot;would you mind&quot;</span><span class="p">,</span> <span class="s2">&quot;I need you to&quot;</span><span class="p">,</span> <span class="s2">&quot;help me&quot;</span>
<span class="linenos">124</span>        <span class="p">]</span>
<span class="linenos">125</span>
<span class="linenos">126</span>        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">127</span>            <span class="s2">&quot;this note&quot;</span><span class="p">,</span> <span class="s2">&quot;the following text&quot;</span><span class="p">,</span> <span class="s2">&quot;the content below&quot;</span><span class="p">,</span> <span class="s2">&quot;this clinical note&quot;</span><span class="p">,</span> <span class="s2">&quot;the text provided&quot;</span>
<span class="linenos">128</span>        <span class="p">]</span>
<span class="linenos">129</span>
<span class="linenos">130</span>        <span class="bp">self</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">131</span>            <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;for me&quot;</span><span class="p">,</span> <span class="s2">&quot;if possible&quot;</span><span class="p">,</span> <span class="s2">&quot;when you can&quot;</span><span class="p">,</span> <span class="s2">&quot;if you can&quot;</span><span class="p">,</span> <span class="s2">&quot;please&quot;</span><span class="p">,</span> <span class="s2">&quot;as soon as possible&quot;</span>
<span class="linenos">132</span>        <span class="p">]</span>
<span class="linenos">133</span>    
<span class="linenos">134</span>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="linenos">135</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">136</span><span class="sd">        Generates list of neutral-based prompts</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="sd">        Args:</span>
<span class="linenos">139</span><span class="sd">            limit (int | None): Limit the number of potential premutations</span>
<span class="linenos">140</span><span class="sd">        </span>
<span class="linenos">141</span><span class="sd">        Returns:</span>
<span class="linenos">142</span><span class="sd">            list[str]: List of premutations</span>
<span class="linenos">143</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">144</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">145</span>
<span class="linenos">146</span>        <span class="k">for</span> <span class="n">verb</span><span class="p">,</span> <span class="n">modifier</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neutral_verbs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffixes</span><span class="p">):</span>
<span class="linenos">147</span>
<span class="linenos">148</span>            <span class="k">if</span> <span class="n">modifier</span><span class="p">:</span>
<span class="linenos">149</span>                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">150</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">151</span>                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">verb</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">152</span>            
<span class="linenos">153</span>            <span class="n">prompts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
<span class="linenos">154</span>
<span class="linenos">155</span>            <span class="k">if</span> <span class="n">modifier</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;can you&quot;</span><span class="p">,</span> <span class="s2">&quot;could you&quot;</span><span class="p">,</span> <span class="s2">&quot;would you mind&quot;</span><span class="p">]:</span>
<span class="linenos">156</span>                <span class="n">prompts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="linenos">157</span>            
<span class="linenos">158</span>        <span class="n">prompts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">})</span>
<span class="linenos">159</span>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
<span class="linenos">160</span>
<span class="linenos">161</span>        <span class="k">return</span> <span class="n">prompts</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">prompts</span>
<span class="linenos">162</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="k">def</span><span class="w"> </span><span class="nf">create_intent_dataset</span><span class="p">(</span><span class="n">note_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">165</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">166</span><span class="sd">    Creates a complete dataset for intent-targeting model training and saves to file. Aims for a balance of correct label prompts, ambiguous prompts, and raw text.</span>
<span class="linenos">167</span>
<span class="linenos">168</span><span class="sd">    Args:</span>
<span class="linenos">169</span><span class="sd">        save_dir (str): location to save dataset</span>
<span class="linenos">170</span><span class="sd">        limit (int | None): limit for number of premutations for each class of target (or just max number of possible prompts)</span>
<span class="linenos">171</span><span class="sd">    </span>
<span class="linenos">172</span><span class="sd">    Returns:</span>
<span class="linenos">173</span><span class="sd">        None</span>
<span class="linenos">174</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">175</span>
<span class="linenos">176</span>    <span class="n">prompter</span> <span class="o">=</span> <span class="n">PromptCreator</span><span class="p">()</span>
<span class="linenos">177</span>    <span class="n">neutral_prompter</span> <span class="o">=</span> <span class="n">NeutralPromptCreator</span><span class="p">()</span>
<span class="linenos">178</span>
<span class="linenos">179</span>    <span class="n">summary_prompts</span> <span class="o">=</span> <span class="n">prompter</span><span class="o">.</span><span class="n">generate_summarization_prompts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
<span class="linenos">180</span>    <span class="n">classify_prompts</span> <span class="o">=</span> <span class="n">prompter</span><span class="o">.</span><span class="n">generate_classification_prompts</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
<span class="linenos">181</span>    <span class="n">neutral_prompts</span> <span class="o">=</span> <span class="n">neutral_prompter</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
<span class="linenos">182</span>
<span class="linenos">183</span>    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">summary_prompts</span><span class="p">:</span>
<span class="linenos">186</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;summarization&quot;</span><span class="p">})</span>
<span class="linenos">187</span>    
<span class="linenos">188</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">classify_prompts</span><span class="p">:</span>
<span class="linenos">189</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;classification&quot;</span><span class="p">})</span>
<span class="linenos">190</span>    
<span class="linenos">191</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">neutral_prompts</span><span class="p">:</span>
<span class="linenos">192</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;summarization&quot;</span><span class="p">,</span> <span class="s2">&quot;classification&quot;</span><span class="p">])</span>
<span class="linenos">193</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
<span class="linenos">194</span>    
<span class="linenos">195</span>    <span class="n">raw_text</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">note_path</span><span class="p">)</span>
<span class="linenos">196</span>
<span class="linenos">197</span>    <span class="n">raw_text</span> <span class="o">=</span> <span class="n">raw_text</span><span class="p">[</span><span class="n">text_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="n">limit</span><span class="p">]</span>
<span class="linenos">198</span>
<span class="linenos">199</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">raw_text</span><span class="p">:</span>
<span class="linenos">200</span>        <span class="n">label</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;summarization&quot;</span><span class="p">,</span> <span class="s2">&quot;classification&quot;</span><span class="p">])</span>
<span class="linenos">201</span>        <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>
<span class="linenos">202</span>    
<span class="linenos">203</span>    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="linenos">204</span>
<span class="linenos">205</span>    <span class="n">dataframe</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Multi-model Biomedical LLM</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="code_reference.html">Code Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Preprocessing Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="training_pipeline.html">Training Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference_pipeline.html">Inference Pipeline</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="code_reference.html" title="previous chapter">Code Reference</a></li>
      <li>Next: <a href="training_pipeline.html" title="next chapter">Training Pipeline</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Alexander Nicholson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/data_pipeline.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>